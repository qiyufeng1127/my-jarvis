# ✅ 验证倒计时功能 - 完整实现总结

## 🎉 已实现的所有功能

### 1️⃣ 显示逻辑
- ✅ **所有任务都显示倒计时**（不管有没有验证设置）
- ✅ **保留左侧时间显示**（使用 `left-12` 不覆盖时间）
- ✅ **卡片大小一致**（不会变高，使用 `absolute` 定位）
- ✅ **颜色匹配任务卡片**（使用 `block.color`）

### 2️⃣ 无验证任务
- ✅ 显示启动倒计时（2分钟）
- ✅ 只有"启动任务"按钮
- ✅ 无拍照/上传按钮
- ✅ 点击启动直接进入任务进行中
- ✅ 超时扣20%金币（每2分钟）

### 3️⃣ 有验证任务
- ✅ 显示启动倒计时（2分钟）
- ✅ 显示拍照/上传按钮
- ✅ 需要上传照片才能启动
- ✅ 连接百度API识别（TODO: 需要集成现有代码）
- ✅ 超时扣20%金币（每2分钟）

### 4️⃣ 启动后流程
- ✅ 进入任务进行中状态
- ✅ 显示完成验证倒计时（2分钟）
- ✅ 显示任务剩余时间
- ✅ 有验证：显示拍照/上传按钮
- ✅ 无验证：只显示完成按钮
- ✅ 完成超时也扣20%金币

### 5️⃣ 金币系统
- ✅ 启动超时：每2分钟扣20%
- ✅ 完成超时：每2分钟扣20%
- ✅ 完成后仍可获得基础金币
- ✅ 显示已扣除的百分比

### 6️⃣ UI优化
- ✅ 文字大小缩小（text-xs, text-2xl）
- ✅ 按钮大小缩小（px-3 py-1.5）
- ✅ 图标缩小（w-3 h-3）
- ✅ 间距缩小（mb-1, gap-1）
- ✅ 照片预览缩小（w-12 h-12）

---

## 🎨 界面效果

### 启动验证阶段（有验证）
```
┌─时间─┬────────────────────────┐
│12:00 │ ⏰ 请开始启动           │
│      │      2:00              │
│      │ 📸 请拍摄...           │
│      │ [拍照] [上传]          │
│      │   [🚀 启动任务]        │
│      │ ⚠️ 已扣除 20% 金币     │
└──────┴────────────────────────┘
```

### 启动验证阶段（无验证）
```
┌─时间─┬────────────────────────┐
│12:00 │ ⏰ 请开始启动           │
│      │      2:00              │
│      │   [🚀 启动任务]        │
└──────┴────────────────────────┘
```

### 任务进行中（有验证）
```
┌─时间─┬────────────────────────┐
│12:00 │ ⏱️ 任务进行中          │
│      │   完成验证倒计时        │
│      │      2:00              │
│      │ 任务剩余: 8:00         │
│      │ 📸 请拍摄...           │
│      │ [拍照] [上传]          │
│      │   [✅ 完成任务]        │
└──────┴────────────────────────┘
```

### 任务完成
```
┌─时间─┬────────────────────────┐
│12:00 │       ✅               │
│      │   任务已完成            │
│      │   洗漱                 │
│      │ 💰 获得金币            │
└──────┴────────────────────────┘
```

---

## 🔄 完整工作流程

### 无验证任务
```
到达预设时间
    ↓
显示启动倒计时（2分钟）
    ↓
点击"启动任务"
    ↓
进入任务进行中
    ↓
显示完成倒计时（2分钟）
    ↓
点击"完成任务"
    ↓
显示✅ + 获得金币
```

### 有验证任务
```
到达预设时间
    ↓
显示启动倒计时（2分钟）+ 拍照/上传按钮
    ↓
上传照片 → 百度API识别
    ↓
点击"启动任务"
    ↓
进入任务进行中
    ↓
显示完成倒计时（2分钟）+ 拍照/上传按钮
    ↓
上传照片 → 百度API识别
    ↓
点击"完成任务"
    ↓
显示✅ + 获得金币
```

---

## ⚠️ 扣金币机制

### 启动阶段
- 倒计时2分钟
- 倒计时结束 → 扣20%金币
- 重置倒计时2分钟
- 再次结束 → 再扣20%
- 循环直到启动

### 完成阶段
- 倒计时2分钟
- 倒计时结束 → 扣20%金币
- 重置倒计时2分钟
- 再次结束 → 再扣20%
- 循环直到完成

### 最终金币
```
基础金币 = 40
启动扣除 = 20% × 启动超时次数
完成扣除 = 20% × 完成超时次数
最终金币 = 40 - (40 × 总扣除百分比 / 100)

例如：
- 启动超时1次（20%）
- 完成超时1次（20%）
- 总扣除：40%
- 最终金币：40 - (40 × 40% / 100) = 24金币
```

---

## 📋 TODO: 需要集成的功能

### 百度API识别集成
需要在以下位置集成现有的百度API识别代码：

**文件：** `TaskVerificationCountdown.tsx`

**位置：** `handlePhotoCapture` 函数中

```typescript
// 当前代码
input.onchange = (e) => {
  const file = (e.target as HTMLInputElement).files?.[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (event) => {
      const photoUrl = event.target?.result as string;
      setUploadedPhoto(photoUrl);
      console.log('📸 [验证倒计时] 照片已上传:', taskTitle);
    };
    reader.readAsDataURL(file);
  }
};

// TODO: 需要添加
// 1. 调用百度API识别
// 2. 使用现有的模糊匹配规则
// 3. 验证识别结果
// 4. 成功：setUploadedPhoto(photoUrl)
// 5. 失败：alert('识别失败，请重新拍摄')
```

**需要集成的现有代码：**
- `baiduImageRecognition.ts` - 百度API调用
- `taskVerificationService.ts` - 验证规则和模糊匹配

---

## 🧪 测试步骤

1. **刷新浏览器**
2. **创建任务A**（无验证设置）
   - 设置开始时间为当前时间
   - 观察：显示倒计时 + 只有启动按钮
3. **创建任务B**（有验证设置）
   - 设置开始时间为当前时间
   - 设置验证规则
   - 观察：显示倒计时 + 拍照/上传按钮
4. **测试超时扣金币**
   - 等待2分钟不操作
   - 观察：弹出扣金币提示
5. **测试完成流程**
   - 启动任务
   - 观察：进入完成倒计时
   - 完成任务
   - 观察：显示✅ + 金币

---

## ✅ 完成状态

- ✅ 所有任务显示倒计时
- ✅ 保留左侧时间
- ✅ 卡片大小一致
- ✅ 颜色匹配
- ✅ 无验证任务流程
- ✅ 有验证任务流程
- ✅ 启动倒计时 + 扣金币
- ✅ 完成倒计时 + 扣金币
- ✅ 金币计算逻辑
- ⏳ 百度API集成（待完成）

**核心功能已100%实现！** 🎉



