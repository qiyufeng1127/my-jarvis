# éªŒè¯å¼€å…³åŠŸèƒ½ - ä½¿ç”¨è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ä»»åŠ¡ç°åœ¨æ”¯æŒ"éªŒè¯æµç¨‹"å¼€å…³ï¼Œå¯ä»¥çµæ´»æ§åˆ¶æ˜¯å¦éœ€è¦å¯åŠ¨éªŒè¯å’Œå®ŒæˆéªŒè¯ï¼š

- **å¼€å…³å¼€å¯**ï¼šç‚¹å‡» Start/å®Œæˆ æŒ‰é’® â†’ è§¦å‘éªŒè¯æµç¨‹ï¼ˆæ‹ç…§éªŒè¯ + å€’è®¡æ—¶ï¼‰
- **å¼€å…³å…³é—­**ï¼šç‚¹å‡» Start/å®Œæˆ æŒ‰é’® â†’ ä»…è®°å½•çœŸå®æ—¶é—´ï¼Œæ— éªŒè¯æµç¨‹

## ğŸ”§ å®ç°æ–¹å¼ï¼ˆä½ä¾µå…¥å¼ï¼‰

### 1. æ ¸å¿ƒä¿®æ”¹ç‚¹

#### `useTaskVerificationManager.ts` - æ·»åŠ å¼€å…³åˆ¤æ–­

```typescript
// åœ¨ handleStartVerification ä¸­æ·»åŠ å¼€å…³åˆ¤æ–­
const handleStartVerification = async (task: Task) => {
  // ğŸ”§ å¼€å…³åˆ¤æ–­ï¼šå¦‚æœæœªå¼€å¯éªŒè¯ï¼Œç›´æ¥è®°å½•å¼€å§‹æ—¶é—´
  if (!task.verificationStart) {
    console.log('âš¡ æœªå¼€å¯éªŒè¯å¼€å…³ï¼Œç›´æ¥è®°å½•å¼€å§‹æ—¶é—´');
    await updateTask(task.id, {
      status: 'in_progress',
      actualStart: new Date(),
    });
    return;
  }
  
  // å¼€å¯äº†éªŒè¯ï¼Œæ‰§è¡ŒéªŒè¯æµç¨‹...
};

// åœ¨ handleCompleteVerification ä¸­æ·»åŠ å¼€å…³åˆ¤æ–­
const handleCompleteVerification = async (task: Task) => {
  // ğŸ”§ å¼€å…³åˆ¤æ–­ï¼šå¦‚æœæœªå¼€å¯éªŒè¯ï¼Œç›´æ¥è®°å½•å®Œæˆæ—¶é—´
  if (!task.verificationComplete) {
    console.log('âš¡ æœªå¼€å¯éªŒè¯å¼€å…³ï¼Œç›´æ¥è®°å½•å®Œæˆæ—¶é—´');
    await updateTask(task.id, {
      status: 'completed',
      actualEnd: new Date(),
    });
    return;
  }
  
  // å¼€å¯äº†éªŒè¯ï¼Œæ‰§è¡ŒéªŒè¯æµç¨‹...
};

// æ–°å¢æ‰‹åŠ¨è§¦å‘æ¥å£
export function useTaskVerificationManager() {
  // ...
  
  const manualStartTask = async (taskId: string) => {
    const task = tasks.find(t => t.id === taskId);
    if (!task) return;
    await handleStartVerification(task);
  };

  const manualCompleteTask = async (taskId: string) => {
    const task = tasks.find(t => t.id === taskId);
    if (!task) return;
    await handleCompleteVerification(task);
  };

  return {
    handleStartVerification,
    handleCompleteVerification,
    manualStartTask,      // ğŸ‘ˆ ä¾›æŒ‰é’®è°ƒç”¨
    manualCompleteTask,   // ğŸ‘ˆ ä¾›æŒ‰é’®è°ƒç”¨
    calculateBaseGold,
    calculateStartGold,
    calculateCompleteGold,
  };
}
```

#### `TaskVerificationExtension.tsx` - é€‚é…å¼€å…³

```typescript
interface TaskVerificationData {
  taskId: string;
  taskTitle: string;
  hasVerification: boolean; // ğŸ”§ æ–°å¢ï¼šæ˜¯å¦å¼€å¯éªŒè¯å¼€å…³
  // ...
}

// åœ¨ç›‘å¬äº‹ä»¶æ—¶åˆ¤æ–­å¼€å…³
useEffect(() => {
  const handleTaskTimeArrived = (data: TaskVerificationData) => {
    // ğŸ”§ å¼€å…³åˆ¤æ–­ï¼šå¦‚æœæœªå¼€å¯éªŒè¯ï¼Œä¸æ˜¾ç¤ºéªŒè¯ç•Œé¢
    if (!data.hasVerification) {
      console.log('â­ï¸ æœªå¼€å¯éªŒè¯å¼€å…³ï¼Œè·³è¿‡éªŒè¯ç•Œé¢');
      return;
    }
    
    // å¼€å¯äº†éªŒè¯ï¼Œæ˜¾ç¤ºéªŒè¯ç•Œé¢...
  };
  
  eventBus.on('taskTimeArrived', handleTaskTimeArrived);
  // ...
}, []);
```

### 2. åœ¨ä»»åŠ¡å¡ç‰‡ä¸­ä½¿ç”¨

```typescript
import { useTaskVerificationManager } from '@/hooks/useTaskVerificationManager';

function TaskCard({ task }: { task: Task }) {
  const { manualStartTask, manualCompleteTask } = useTaskVerificationManager();
  
  return (
    <div className="task-card">
      <h3>{task.title}</h3>
      
      {/* Start æŒ‰é’® */}
      {task.status === 'scheduled' && (
        <button onClick={() => manualStartTask(task.id)}>
          {task.verificationStart ? 'å¯åŠ¨éªŒè¯' : 'å¼€å§‹ä»»åŠ¡'}
        </button>
      )}
      
      {/* å®ŒæˆæŒ‰é’® */}
      {task.status === 'in_progress' && (
        <button onClick={() => manualCompleteTask(task.id)}>
          {task.verificationComplete ? 'å®ŒæˆéªŒè¯' : 'å®Œæˆä»»åŠ¡'}
        </button>
      )}
    </div>
  );
}
```

## ğŸ¯ å·¥ä½œæµç¨‹

### å¼€å¯éªŒè¯å¼€å…³æ—¶

```
ç”¨æˆ·ç‚¹å‡» Start æŒ‰é’®
    â†“
manualStartTask(taskId)
    â†“
handleStartVerification(task)
    â†“
æ£€æŸ¥ task.verificationStart âœ… å­˜åœ¨
    â†“
æ›´æ–°çŠ¶æ€ä¸º 'verifying_start'
    â†“
æ˜¾ç¤ºéªŒè¯ç•Œé¢ï¼ˆæ‹ç…§ + å€’è®¡æ—¶ï¼‰
    â†“
ç”¨æˆ·å®ŒæˆéªŒè¯
    â†“
æ›´æ–°çŠ¶æ€ä¸º 'in_progress' + è®°å½• actualStart
```

### å…³é—­éªŒè¯å¼€å…³æ—¶

```
ç”¨æˆ·ç‚¹å‡» Start æŒ‰é’®
    â†“
manualStartTask(taskId)
    â†“
handleStartVerification(task)
    â†“
æ£€æŸ¥ task.verificationStart âŒ ä¸å­˜åœ¨
    â†“
ç›´æ¥æ›´æ–°çŠ¶æ€ä¸º 'in_progress' + è®°å½• actualStart
    â†“
å®Œæˆï¼ˆæ— éªŒè¯æµç¨‹ï¼‰
```

## ğŸ“Š å¼€å…³çŠ¶æ€åˆ¤æ–­

```typescript
// åˆ¤æ–­æ˜¯å¦å¼€å¯å¯åŠ¨éªŒè¯
const hasStartVerification = !!task.verificationStart;

// åˆ¤æ–­æ˜¯å¦å¼€å¯å®ŒæˆéªŒè¯
const hasCompleteVerification = !!task.verificationComplete;

// å®Œå…¨å…³é—­éªŒè¯
const noVerification = !task.verificationStart && !task.verificationComplete;
```

## âœ… ä¼˜åŠ¿

1. **ä½ä¾µå…¥**ï¼šåªä¿®æ”¹äº† 3 ä¸ªå‡½æ•°ï¼Œæ–°å¢äº† 2 ä¸ªæ¥å£
2. **å‘åå…¼å®¹**ï¼šä¸å½±å“ç°æœ‰ä»£ç ï¼Œå®Œå…¨å…¼å®¹
3. **çµæ´»æ§åˆ¶**ï¼šæ¯ä¸ªä»»åŠ¡å¯ç‹¬ç«‹è®¾ç½®æ˜¯å¦éœ€è¦éªŒè¯
4. **é€»è¾‘æ¸…æ™°**ï¼šå¼€å…³åˆ¤æ–­åœ¨æœ€å‰é¢ï¼Œä¸€ç›®äº†ç„¶
5. **æ˜“äºç»´æŠ¤**ï¼šä»£ç ç»“æ„æ¸…æ™°ï¼Œæ³¨é‡Šå®Œæ•´

## ğŸ” è°ƒè¯•æ—¥å¿—

```
// å¼€å¯éªŒè¯æ—¶
ğŸš€ [éªŒè¯ç®¡ç†å™¨] è§¦å‘å¯åŠ¨éªŒè¯: ä»»åŠ¡åç§°
ğŸ”” æ”¶åˆ°ä»»åŠ¡éªŒè¯è§¦å‘äº‹ä»¶: {...}
âœ… [éªŒè¯ç®¡ç†å™¨] å¯åŠ¨éªŒè¯æˆåŠŸ: ä»»åŠ¡åç§°

// å…³é—­éªŒè¯æ—¶
ğŸš€ [éªŒè¯ç®¡ç†å™¨] è§¦å‘å¯åŠ¨éªŒè¯: ä»»åŠ¡åç§°
âš¡ [éªŒè¯ç®¡ç†å™¨] æœªå¼€å¯éªŒè¯å¼€å…³ï¼Œç›´æ¥è®°å½•å¼€å§‹æ—¶é—´
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ç±»å‹å®šä¹‰**ï¼š`Task` ç±»å‹ä¸­çš„ `verificationStart` å’Œ `verificationComplete` å­—æ®µæ˜¯å¯é€‰çš„
2. **çŠ¶æ€æµè½¬**ï¼šå…³é—­éªŒè¯æ—¶ï¼ŒçŠ¶æ€ç›´æ¥ä» `scheduled` â†’ `in_progress` â†’ `completed`
3. **é‡‘å¸è®¡ç®—**ï¼šå…³é—­éªŒè¯æ—¶ï¼Œå¯ä»¥æ ¹æ®å®é™…æ—¶é•¿è®¡ç®—é‡‘å¸ï¼ˆæ— éªŒè¯å¥–åŠ±/æƒ©ç½šï¼‰
4. **æ—¶é—´è®°å½•**ï¼šæ— è®ºæ˜¯å¦å¼€å¯éªŒè¯ï¼Œéƒ½ä¼šè®°å½• `actualStart` å’Œ `actualEnd`

## ğŸš€ ä¸‹ä¸€æ­¥æ‰©å±•

å¦‚æœéœ€è¦æ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œå¯ä»¥æ·»åŠ ï¼š

1. **ä»…å¯åŠ¨éªŒè¯**ï¼š`verificationStart` å­˜åœ¨ï¼Œ`verificationComplete` ä¸å­˜åœ¨
2. **ä»…å®ŒæˆéªŒè¯**ï¼š`verificationStart` ä¸å­˜åœ¨ï¼Œ`verificationComplete` å­˜åœ¨
3. **éªŒè¯ä¸¥æ ¼åº¦**ï¼š`verificationStrictness: 'low' | 'medium' | 'high'`
4. **éªŒè¯ç±»å‹**ï¼š`verificationType: 'photo' | 'text' | 'location'`




