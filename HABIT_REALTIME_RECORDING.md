# 坏习惯实时记录系统 - 完整实现

## 🎯 功能概述

所有类型的坏习惯现在都支持**实时自动记录**，不再需要等到每日00:01结算。

## ✅ 支持的坏习惯类型

### 1. 任务状态规则（实时记录）

#### 拖延 🕒
- **触发条件**：任务启动倒计时（2分钟）超时
- **记录时机**：每次超时立即记录
- **记录格式**：`00:36 任务「新任务」启动超时`
- **实时性**：✅ 每分钟检查一次

#### 低效率 🐢
- **触发条件**：任务完成倒计时（10分钟）超时
- **记录时机**：每次超时立即记录
- **记录格式**：`00:40 任务「新任务」完成超时`
- **实时性**：✅ 每分钟检查一次

### 2. 时间阈值规则（实时记录）

#### 熬夜 🌙
- **触发条件**：最后一个任务结束时间晚于设定时间（默认24:00）
- **记录时机**：创建/修改任务时立即检查
- **记录格式**：`23:30 最后一个任务时间为 2026-02-24 23:30`
- **实时性**：✅ 每分钟检查一次

#### 晚起 🛌
- **触发条件**：第一个任务开始时间晚于设定时间（默认10:30）
- **记录时机**：创建/修改任务时立即检查
- **记录格式**：`11:00 第一个任务时间为 2026-02-24 11:00`
- **实时性**：✅ 每分钟检查一次

### 3. 关键词规则（实时记录）

#### 点外卖 🍱
- **触发条件**：任务标题/描述/标签包含"外卖"、"美团"、"饿了么"、"点餐"
- **记录时机**：创建/修改任务时立即检查
- **记录格式**：`12:00 任务「点外卖」包含关键词`
- **实时性**：✅ 每分钟检查一次

#### 不吃午饭 🥣
- **触发条件**：11:30-13:00 时间段内没有包含"午饭"、"午餐"、"就餐"、"吃饭"的任务
- **记录时机**：13:00 后立即检查
- **记录格式**：`13:00 11:30-13:00 未找到包含关键词的任务`
- **实时性**：✅ 每分钟检查一次

### 4. 自定义坏习惯（实时记录）

用户可以自定义任何类型的坏习惯，都支持实时记录：

#### 时间阈值类型
- 例如：午睡时间晚于 14:00
- 例如：晚饭时间早于 18:00

#### 关键词类型
- 例如：刷抖音（关键词：抖音、短视频）
- 例如：不运动（反向规则，关键词：运动、健身）

## 🔄 工作流程

```
应用启动
  ↓
初始化坏习惯监控服务
  ↓
┌─────────────────────────────────────┐
│  立即执行一次检查                    │
│  - 检查所有启用的坏习惯规则          │
└─────────────────────────────────────┘
  ↓
┌─────────────────────────────────────┐
│  每分钟检查一次（实时监控）          │
│                                      │
│  1. 任务状态规则                     │
│     - 从 localStorage 读取超时数据   │
│     - 只记录新增的超时次数           │
│     - 每次超时单独记录一条           │
│                                      │
│  2. 时间阈值规则                     │
│     - 检查第一个/最后一个任务时间    │
│     - 与设定阈值比较                 │
│     - 违规立即记录                   │
│                                      │
│  3. 关键词规则                       │
│     - 检查任务标题/描述/标签         │
│     - 匹配关键词                     │
│     - 存在/不存在立即记录            │
└─────────────────────────────────────┘
  ↓
┌─────────────────────────────────────┐
│  记录到坏习惯罐头                    │
│  - 每条记录独立显示                  │
│  - 包含时间戳和原因                  │
│  - 可关联到具体任务                  │
└─────────────────────────────────────┘
```

## 📊 记录示例

### 拖延（超时3次）
```
拖延 发生 3 次

00:36 任务「新任务」启动超时
00:38 任务「新任务」启动超时
00:40 任务「新任务」启动超时
```

### 熬夜
```
熬夜 发生 1 次

23:30 最后一个任务时间为 2026-02-24 23:30
```

### 点外卖
```
点外卖 发生 2 次

12:00 任务「点美团外卖」包含关键词
18:30 任务「饿了么点餐」包含关键词
```

### 不吃午饭
```
不吃午饭 发生 1 次

13:00 11:30-13:00 未找到包含关键词的任务
```

## 🎯 防重复记录机制

每种坏习惯都有独立的防重复记录机制：

### 任务状态规则
```javascript
// 记录已记录的次数
const recordedKey = `habit_recorded_start_count_${task.id}_${today}`;
const recordedCount = parseInt(localStorage.getItem(recordedKey) || '0');

// 只记录新增的超时
const newTimeouts = timeoutCount - recordedCount;
```

### 时间阈值规则
```javascript
// 每个任务只记录一次
const recordKey = `habit_recorded_time_${habit.id}_${task.id}_${today}`;
if (localStorage.getItem(recordKey)) return;
```

### 关键词规则（存在型）
```javascript
// 每个匹配的任务只记录一次
const recordKey = `habit_recorded_keyword_${habit.id}_${task.id}_${today}`;
if (localStorage.getItem(recordKey)) return;
```

### 关键词规则（不存在型）
```javascript
// 每天只记录一次
const recordKey = `habit_recorded_keyword_${habit.id}_${today}`;
if (localStorage.getItem(recordKey)) return;
```

## 🧪 测试方法

### 测试拖延（任务状态规则）
1. 创建一个任务
2. 等待启动倒计时超时（2分钟）
3. 查看坏习惯罐头，应该看到1条"拖延"记录
4. 再等待2分钟（第2次超时）
5. 查看坏习惯罐头，应该看到2条"拖延"记录

### 测试熬夜（时间阈值规则）
1. 创建一个任务，结束时间设置为 23:30
2. 等待1分钟
3. 查看坏习惯罐头，应该看到1条"熬夜"记录

### 测试点外卖（关键词规则）
1. 创建一个任务，标题包含"外卖"
2. 等待1分钟
3. 查看坏习惯罐头，应该看到1条"点外卖"记录

### 测试不吃午饭（关键词规则-反向）
1. 确保 11:30-13:00 时间段内没有包含"午饭"的任务
2. 等到 13:01
3. 查看坏习惯罐头，应该看到1条"不吃午饭"记录

## 🐛 调试技巧

### 查看监控服务状态
```javascript
// 在控制台执行
const { habitMonitorService } = await import('./src/services/habitMonitorService');

// 手动触发检查
habitMonitorService.checkNow();
```

### 查看今天的坏习惯记录
```javascript
const { useHabitCanStore } = await import('./src/stores/habitCanStore');
const store = useHabitCanStore.getState();
const today = new Date().toISOString().split('T')[0];

console.log('今天的记录:', store.getOccurrencesByDate(today));
console.log('今天的罐头:', store.getCanData(today));
```

### 清除防重复记录标记（用于测试）
```javascript
// 清除所有坏习惯记录标记
Object.keys(localStorage)
  .filter(key => key.startsWith('habit_recorded_'))
  .forEach(key => localStorage.removeItem(key));

console.log('✅ 已清除所有记录标记');
```

## ✅ 验收标准

完成后，系统应该能够：

1. ✅ 实时记录任务启动超时（拖延）
2. ✅ 实时记录任务完成超时（低效率）
3. ✅ 实时记录熬夜（最后任务晚于阈值）
4. ✅ 实时记录晚起（第一任务晚于阈值）
5. ✅ 实时记录点外卖（任务包含关键词）
6. ✅ 实时记录不吃午饭（时间段内无相关任务）
7. ✅ 支持用户自定义坏习惯规则
8. ✅ 每条记录独立显示，包含时间戳
9. ✅ 防止重复记录
10. ✅ 每分钟自动检查更新

## 🎉 完成！

现在刷新浏览器，所有坏习惯都会实时自动记录到罐头中了！

每次有坏习惯发生，都会立即添加一条新记录，包含：
- 🕐 时间戳
- 😊 Emoji 图标
- 📝 详细原因
- 🔗 关联任务（如果有）

