# 标签与时间轴同步功能说明

## 功能概述

现在标签组件已经与时间轴完美关联！每当你完成一个任务，系统会自动将任务数据同步到相关标签的统计中。

## 自动同步的数据

当任务完成时，系统会自动记录：

### 1. 使用次数
- 每完成一个带标签的任务，该标签的使用次数 +1

### 2. 时长统计
- **总时长**：任务的实际执行时间（actualEnd - actualStart）
- **有效时长**：排除无效时长后的时间
- **无效时长**：失败、取消、超时或质量评分<3的任务时长

### 3. 财务数据
- **收入**：任务获得的金币奖励（goldEarned）
- **支出**：任务的惩罚金币（penaltyGold）
- **净收支**：收入 - 支出

### 4. 效率指标
- **时薪**：净收支 / 有效时长（元/小时）
- 自动计算并更新

## 使用方法

### 自动同步（推荐）

系统已经在应用启动时自动启动了标签同步服务。你只需要：

1. 在时间轴上创建任务时，给任务添加标签
2. 完成任务后，系统会自动同步数据到标签

**无需任何手动操作！**

### 手动同步（修复数据）

如果你发现标签统计数据不准确，可以手动触发重新计算：

1. 打开标签管理器（Statistics）
2. 点击右上角的 🔄 按钮（同步时间轴数据）
3. 确认后，系统会：
   - 清空所有标签的统计数据
   - 从所有已完成的任务重新计算
   - 重新生成时长记录和财务记录

## 标签统计展示

在标签管理器中，你可以看到每个标签的：

- 📊 使用次数
- ⏱️ 总时长
- 💰 收入
- 💸 支出
- 📈 时薪
- ⚠️ 无效时长

## 标签排序

标签列表支持多种排序方式：

- **使用次数**：最常用的标签
- **收入**：赚钱最多的标签
- **支出**：花钱最多的标签
- **净收支**：最赚钱/最亏钱的标签
- **时薪**：效率最高的标签
- **负面时间**：浪费时间最多的标签

## 标签文件夹

标签可以分类到文件夹中：

- 文件夹的颜色会应用到该文件夹下所有标签的任务卡片
- 文件夹可以帮助你更好地组织标签
- 使用 AI 智能分类功能，自动将标签归类到合适的文件夹

## 技术实现

### 核心服务

- `tagSyncService.ts`：标签同步服务
  - `syncTaskToTags()`：同步单个任务到标签
  - `syncAllCompletedTasks()`：批量同步所有已完成任务
  - `recalculateAllTagStats()`：重新计算所有标签统计
  - `startAutoSync()`：启动自动同步监听

### 数据流

```
任务完成 → taskStore.completeTask()
         ↓
    计算金币奖励
         ↓
    更新任务状态（status: 'completed'）
         ↓
    tagSyncService.syncTaskToTags()
         ↓
    更新标签统计（使用次数、时长、收入、支出、时薪）
```

### 存储

- 标签数据存储在 `tagStore`
- 任务数据存储在 `taskStore`
- 使用 Zustand persist 中间件持久化到 localStorage

## 注意事项

1. **只同步已完成的任务**：进行中或待办的任务不会计入统计
2. **无效时长判断**：
   - 任务失败或取消
   - 启动验证超时
   - 完成验证超时
   - 任务质量评分 < 3
3. **时薪计算**：只基于有效时长计算，无效时长不计入
4. **标签重命名**：重命名标签后，所有历史记录会自动更新

## 示例场景

### 场景1：照相馆工作

1. 创建任务："修10张照片"
2. 添加标签：`照相馆工作`
3. 完成任务，获得 50 金币
4. 标签统计自动更新：
   - 使用次数：+1
   - 总时长：+60分钟
   - 收入：+50
   - 时薪：50元/小时

### 场景2：家务

1. 创建任务："打扫卫生"
2. 添加标签：`家务`
3. 完成任务，获得 10 金币
4. 标签统计自动更新：
   - 使用次数：+1
   - 总时长：+30分钟
   - 收入：+10
   - 时薪：20元/小时

### 场景3：学习（无收入）

1. 创建任务："学习编程"
2. 添加标签：`学习`
3. 完成任务，获得 0 金币
4. 标签统计自动更新：
   - 使用次数：+1
   - 总时长：+120分钟
   - 收入：0
   - 时薪：0元/小时

## 常见问题

### Q: 为什么标签统计数据不准确？

A: 可能是因为：
1. 旧任务在同步功能上线前完成，没有记录
2. 数据迁移或导入导致不一致

**解决方法**：点击标签管理器中的 🔄 按钮，重新计算所有数据

### Q: 可以手动修改标签统计数据吗？

A: 不建议。标签统计数据是从任务自动计算的，手动修改会在下次同步时被覆盖。

如果需要调整，应该修改任务数据（如金币奖励、时长等）。

### Q: 删除任务后，标签统计会更新吗？

A: 目前不会自动更新。如果删除了任务，建议手动触发重新计算。

### Q: 一个任务可以有多个标签吗？

A: 可以！每个标签都会独立记录该任务的数据。

例如：任务"修图+发小红书"有标签 `照相馆工作` 和 `小红书运营`，
两个标签都会记录这个任务的时长和收入。

## 未来计划

- [ ] 标签趋势图表（时长、收入随时间变化）
- [ ] 标签对比分析（哪些标签最赚钱、最高效）
- [ ] 标签目标设置（每周/每月目标时长或收入）
- [ ] 标签推荐（根据历史数据推荐高效标签）
- [ ] 标签报告（周报、月报）

