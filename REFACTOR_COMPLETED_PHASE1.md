# 重构完成 - 阶段1：核心倒计时逻辑

## ✅ 已完成功能

### 1. 启动倒计时（2分钟）
- ✅ 预设时间到达时自动触发启动倒计时
- ✅ 倒计时流速与真实时间一致（每秒-1）
- ✅ 刷新浏览器保留剩余时间（localStorage持久化）
- ✅ 倒计时嵌套在事件卡片内，覆盖原有内容
- ✅ 超时循环扣金币（每2分钟扣20%任务总金币）
- ✅ 2分钟内完成启动奖励50%金币
- ✅ 实时显示扣除金币数量和超时次数

### 2. 完成倒计时（任务总时长）
- ✅ 启动成功后自动触发完成倒计时
- ✅ 倒计时基于任务预设时长
- ✅ 提前完成奖励50%金币
- ✅ 超时每10分钟扣20%金币
- ✅ 循环扣除直到完成
- ✅ 实时显示扣除金币数量和超时次数

### 3. 验证流程优化
- ✅ 上传照片自动触发验证
- ✅ 验证结果显示在卡片内（无浏览器弹窗）
- ✅ 验证成功自动进入下一步（1秒延迟）
- ✅ 验证失败可重新上传
- ✅ 显示识别到的内容

### 4. 状态持久化
- ✅ 使用localStorage保存倒计时状态
- ✅ 刷新浏览器自动恢复状态
- ✅ 根据最后更新时间计算实际剩余时间
- ✅ 完成任务后自动清除持久化数据

### 5. 金币系统集成
- ✅ 启动超时实时扣金币
- ✅ 完成超时实时扣金币
- ✅ 按时启动奖励50%金币
- ✅ 提前完成奖励50%金币
- ✅ 所有金币操作同步到右上角金币组件

## 📋 核心逻辑流程

### 无验证任务
```
等待启动 → 预设时间到达 → 启动倒计时(2分钟) → 点击"启动任务" 
→ 完成倒计时(任务总时长) → 点击"完成任务" → 已完成
```

### 有验证任务
```
等待启动 → 预设时间到达 → 启动倒计时(2分钟) → 点击"启动验证" 
→ 上传照片 → 自动验证 → 验证成功 → 完成倒计时(任务总时长) 
→ 点击"完成验证" → 上传照片 → 自动验证 → 验证成功 → 已完成
```

## 🎯 金币奖惩规则

### 启动阶段
- **按时启动（2分钟内）**：奖励任务总金币的50%
- **超时启动**：每超时2分钟扣除任务总金币的20%，循环扣除

### 完成阶段
- **提前完成（预设时长内）**：奖励任务总金币的50%
- **超时完成**：每超时10分钟扣除任务总金币的20%，循环扣除

### 示例（任务总金币200）
- 按时启动：+100金币
- 超时1次启动：-40金币
- 超时3次启动：-120金币
- 提前完成：+100金币
- 超时2次完成：-80金币

## 🔧 技术实现

### 状态管理
```typescript
interface CountdownState {
  status: CountdownStatus;
  startCountdownLeft: number;    // 启动倒计时剩余秒数
  taskCountdownLeft: number;     // 任务倒计时剩余秒数
  startTimeoutCount: number;     // 启动超时次数
  completeTimeoutCount: number;  // 完成超时次数
  actualStartTime: string | null;
  lastUpdateTime: string;        // 最后更新时间
}
```

### 持久化机制
- 使用localStorage存储状态
- 每次状态更新自动保存
- 恢复状态时根据时间差计算实际剩余时间
- 完成任务后清除数据

### 倒计时精准性
- 使用setInterval每秒更新
- 状态更新时记录lastUpdateTime
- 恢复状态时计算elapsed时间
- 确保倒计时与真实时间一致

## 📝 控制台日志

### 成功日志
- `⏰ 任务到达预设时间，触发启动倒计时`
- `✅ 按时启动任务，获得X金币奖励`
- `✅ 启动验证成功，任务时长X分钟`
- `✅ 提前完成任务，获得X金币奖励`
- `✅ 完成任务`

### 警告日志
- `⚠️ 启动超时！扣除X金币（X次）`
- `⚠️ 完成超时！扣除X金币（X次）`
- `⚠️ 累计扣除X金币（X次超时）`

### 验证日志
- `📦 加载倒计时状态`
- `💾 保存倒计时状态`
- `✅ 验证成功！已识别到：XX`
- `❌ 验证未通过，请重新拍摄`

## 🚀 下一步计划

### 阶段2：时间动态更新
- [ ] 启动时间替换预设开始时间
- [ ] 完成时间替换预设结束时间
- [ ] 时间轴同步更新

### 阶段3：NOW线自动滚动
- [ ] 自动滚动到当前时间位置
- [ ] 平滑滚动动画

### 阶段4：金币系统重构
- [ ] 移除独立金币组件
- [ ] 集成到右上角按钮
- [ ] 金币明细查看
- [ ] 奖励商店

### 阶段5：代码清理
- [ ] 删除冗余倒计时代码
- [ ] 精简控制台输出
- [ ] 优化性能

## 🎉 测试建议

1. **创建测试任务**：设置开始时间为当前时间+1分钟
2. **等待自动触发**：观察启动倒计时是否自动开始
3. **测试超时**：等待2分钟不操作，观察是否扣金币
4. **测试刷新**：刷新浏览器，观察倒计时是否保留
5. **测试验证**：上传照片，观察验证流程是否自动进行
6. **测试完成**：完成任务，观察金币奖励是否正确

## 📌 注意事项

1. 倒计时状态存储在localStorage，清除浏览器数据会丢失
2. 金币计算基于任务总金币（goldReward字段）
3. 验证关键词需要在任务设置中配置
4. 所有时间计算基于本地时间，不受时区影响

