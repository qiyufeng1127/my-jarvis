# 任务验证系统使用指南

## 📋 系统概述

任务验证系统是ManifestOS的核心防拖延机制，通过**启动验证**和**完成验证**确保任务真实执行，并通过**分阶段金币奖励**激励用户快速启动和高效完成任务。

---

## 🎯 核心特性

### 1. 分阶段金币奖励

- **启动验证通过**：获得 **30%** 金币奖励
- **完成验证通过**：获得 **70%** 金币奖励
- **总计**：完整完成任务可获得 **100%** 金币奖励

**示例**：
```
任务：健身60分钟
基础金币 = 60分钟 × 1.5 = 90金币

启动验证通过 → 获得 27金币（30%）
完成验证通过 → 获得 63金币（70%）
总计获得 → 90金币（100%）
```

---

### 2. 自动触发验证

系统会在任务开始时间**自动触发启动验证**：

```
任务计划时间：15:30
系统行为：
  - 15:30:00 自动触发启动验证
  - 全屏显示验证界面
  - 语音提醒："任务启动验证已开始，请拍摄照片"
  - 倒计时开始（默认2分钟）
```

---

### 3. 智能提醒

#### 启动提醒
- **触发时间**：任务开始时间
- **提醒方式**：全屏界面 + 语音提醒
- **倒计时**：2分钟（可配置）

#### 完成提醒
- **触发时间**：任务结束前5分钟
- **提醒方式**：语音提醒 + 系统通知
- **提醒内容**："任务即将完成，请准备拍摄照片进行验证"

---

### 4. 宽松验证标准

使用百度图像识别API，采用**宽松验证标准**：
- ✅ 只要照片中包含任务相关物品即可通过
- ✅ 支持模糊匹配（例如"厨房"可匹配"灶台"、"炉灶"、"橱柜"等）
- ✅ 不需要完全匹配所有关键词

---

## 🔧 集成步骤

### 步骤1：在App.tsx中添加全局验证管理器

```typescript
// src/App.tsx
import GlobalVerificationManager from '@/components/task/GlobalVerificationManager';

function App() {
  return (
    <div className="App">
      {/* 其他组件 */}
      
      {/* 添加全局验证管理器 */}
      <GlobalVerificationManager />
    </div>
  );
}

export default App;
```

---

### 步骤2：配置百度API

在用户设置中配置百度API密钥：

```typescript
// 方式1：通过UI设置（推荐）
// 打开设置页面 → API配置 → 填入密钥

// 方式2：通过代码设置
localStorage.setItem('user-settings', JSON.stringify({
  baiduApiKey: 'your_api_key',
  baiduSecretKey: 'your_secret_key',
  // ... 其他设置
}));
```

---

### 步骤3：创建带验证的任务

```typescript
import { useTaskStore } from '@/stores/taskStore';

const { createTask } = useTaskStore();

// 创建带验证的任务
await createTask({
  title: '洗碗',
  description: '清洗今天的碗筷',
  taskType: 'life',
  priority: 2,
  durationMinutes: 15,
  scheduledStart: new Date('2026-02-09T15:30:00'), // 15:30开始
  scheduledEnd: new Date('2026-02-09T15:45:00'),   // 15:45结束
  
  // 启动验证配置
  verificationStart: {
    type: 'photo',
    requirement: '拍摄厨房水槽的照片',
    timeout: 120 // 2分钟
  },
  
  // 完成验证配置
  verificationComplete: {
    type: 'photo',
    requirement: '拍摄洗好的碗筷',
    timeout: 120 // 2分钟
  },
  
  // 启用进度检查（可选）
  enableProgressCheck: false,
});
```

---

## 📱 用户体验流程

### 完整流程示例

假设用户创建了一个"洗碗"任务，计划15:30开始：

#### 1. 任务开始（15:30）

```
系统行为：
  ✅ 自动触发启动验证
  ✅ 全屏显示验证界面
  ✅ 语音提醒："任务洗碗启动验证已开始，请拍摄厨房水槽的照片"
  ✅ 倒计时开始：2分钟

用户界面：
  ┌─────────────────────────────────┐
  │  🚀 启动验证                     │
  │  洗碗                            │
  │  ⏰ 剩余时间：1:58               │
  ├─────────────────────────────────┤
  │  📋 验证要求                     │
  │  拍摄厨房水槽的照片              │
  ├─────────────────────────────────┤
  │  📷 点击拍照                     │
  │  或从相册选择照片                │
  └─────────────────────────────────┘
```

#### 2. 用户拍照

```
用户操作：
  1. 点击"拍照"按钮
  2. 拍摄厨房水槽照片
  3. 预览照片
  4. 点击"提交验证"

系统行为：
  ✅ 调用百度图像识别API
  ✅ 识别照片中的物体：水槽、碗、筷子、洗洁精
  ✅ 匹配任务关键词：厨房、水槽
  ✅ 验证通过！
```

#### 3. 启动验证通过

```
系统行为：
  ✅ 任务状态变为"进行中"
  ✅ 记录实际开始时间：15:30:25
  ✅ 奖励金币：27金币（30%）
  ✅ 语音提醒："启动验证通过，获得27金币，任务已开始"
  ✅ 安排完成提醒：15:40（提前5分钟）

用户界面：
  ┌─────────────────────────────────┐
  │  ✅ 验证通过！                   │
  │  照片验证通过！识别到与任务相关  │
  │  的物体：水槽、碗                │
  │                                  │
  │  🎁 获得奖励：💰 27金币          │
  │                                  │
  │  识别到的物体：                  │
  │  [水槽] [碗] [筷子] [洗洁精]     │
  └─────────────────────────────────┘
```

#### 4. 任务进行中（15:30-15:45）

```
系统行为：
  ✅ 任务卡片显示"进行中"状态
  ✅ 已获得金币：27金币
  ✅ 等待完成提醒...
```

#### 5. 完成提醒（15:40，提前5分钟）

```
系统行为：
  ✅ 语音提醒："任务洗碗即将完成，请准备拍摄照片进行验证"
  ✅ 系统通知："洗碗 将在5分钟后完成，请准备验证照片"
```

#### 6. 用户手动触发完成验证（15:45）

```
用户操作：
  1. 点击任务卡片的"完成"按钮
  2. 系统自动触发完成验证

系统行为：
  ✅ 全屏显示验证界面
  ✅ 语音提醒："任务洗碗完成验证已开始，请拍摄照片"
  ✅ 倒计时开始：2分钟

用户界面：
  ┌─────────────────────────────────┐
  │  ✅ 完成验证                     │
  │  洗碗                            │
  │  ⏰ 剩余时间：1:58               │
  ├─────────────────────────────────┤
  │  📋 验证要求                     │
  │  拍摄洗好的碗筷                  │
  ├─────────────────────────────────┤
  │  📷 点击拍照                     │
  │  或从相册选择照片                │
  └─────────────────────────────────┘
```

#### 7. 完成验证通过

```
系统行为：
  ✅ 任务状态变为"已完成"
  ✅ 记录实际结束时间：15:45:30
  ✅ 奖励金币：63金币（70%）
  ✅ 总金币：90金币（27 + 63）
  ✅ 语音提醒："完成验证通过，获得63金币，任务已完成，总共获得90金币"

用户界面：
  ┌─────────────────────────────────┐
  │  ✅ 验证通过！                   │
  │  照片验证通过！识别到与任务相关  │
  │  的物体：碗、筷子                │
  │                                  │
  │  🎁 获得奖励：💰 63金币          │
  │  💰 总计获得：90金币             │
  │                                  │
  │  🎉 任务已完成！                 │
  └─────────────────────────────────┘
```

---

## ⚠️ 失败场景

### 场景1：启动验证超时

```
情况：用户在2分钟内未提交照片

系统行为：
  ❌ 任务状态变为"失败"
  ❌ 扣除金币：45金币（50%惩罚）
  ❌ 语音提醒："启动验证失败，扣除45金币"

金币计算：
  基础金币 = 90金币
  惩罚 = 90 × 0.5 = 45金币
```

---

### 场景2：启动验证失败

```
情况：用户提交的照片未通过验证（例如拍摄了客厅而不是厨房）

系统行为：
  ❌ 显示验证失败界面
  ❌ 提示原因："照片中未识别到厨房相关物品"
  ❌ 提供选项：重新拍照 或 确认失败

用户选择"确认失败"：
  ❌ 任务状态变为"失败"
  ❌ 扣除金币：45金币（50%惩罚）
  ❌ 语音提醒："启动验证失败，扣除45金币"

用户选择"重新拍照"：
  ✅ 返回拍照界面
  ✅ 倒计时继续
  ✅ 可以重新提交照片
```

---

### 场景3：完成验证失败

```
情况：用户提交的照片未通过验证

系统行为：
  ❌ 任务状态变为"失败"
  ❌ 扣除金币：27金币（30%惩罚）
  ❌ 已获得的启动金币不会被扣除
  ❌ 语音提醒："完成验证失败，扣除27金币"

金币计算：
  启动验证已获得 = 27金币（保留）
  完成验证惩罚 = 90 × 0.3 = 27金币
  最终金币 = 27 - 27 = 0金币
```

---

## 💰 金币奖惩详解

### 奖励机制

| 阶段 | 奖励比例 | 计算公式 | 示例（90金币任务） |
|------|---------|---------|-------------------|
| 启动验证通过 | 30% | 基础金币 × 0.3 | 27金币 |
| 完成验证通过 | 70% | 基础金币 × 0.7 | 63金币 |
| 总计 | 100% | 启动 + 完成 | 90金币 |

### 惩罚机制

| 失败类型 | 惩罚比例 | 计算公式 | 示例（90金币任务） |
|---------|---------|---------|-------------------|
| 启动验证超时 | 50% | 基础金币 × 0.5 | -45金币 |
| 启动验证失败 | 50% | 基础金币 × 0.5 | -45金币 |
| 完成验证超时 | 30% | 基础金币 × 0.3 | -27金币 |
| 完成验证失败 | 30% | 基础金币 × 0.3 | -27金币 |

### 金币流转示例

#### 完美完成
```
任务：健身60分钟（基础90金币）

启动验证通过 → +27金币（余额：27）
完成验证通过 → +63金币（余额：90）

最终：获得90金币 ✅
```

#### 启动失败
```
任务：健身60分钟（基础90金币）

启动验证失败 → -45金币（余额：-45）

最终：欠债45金币 ❌
```

#### 启动成功，完成失败
```
任务：健身60分钟（基础90金币）

启动验证通过 → +27金币（余额：27）
完成验证失败 → -27金币（余额：0）

最终：0金币（白干了） ❌
```

---

## 🎨 UI界面设计

### 验证界面布局

```
┌─────────────────────────────────────────┐
│  [头部 - 渐变背景]                       │
│  🚀 启动验证                             │
│  洗碗                                    │
│  ⏰ 剩余时间：1:58                       │
├─────────────────────────────────────────┤
│  [验证要求 - 蓝色背景]                   │
│  ℹ️ 验证要求                             │
│  拍摄厨房水槽的照片                      │
├─────────────────────────────────────────┤
│  [拍照区域]                              │
│  📷                                      │
│  点击拍照                                │
│  或从相册选择照片                        │
├─────────────────────────────────────────┤
│  [预览区域 - 拍照后显示]                 │
│  [照片预览]                              │
│  [重新拍照] [提交验证]                   │
├─────────────────────────────────────────┤
│  [验证结果 - 验证后显示]                 │
│  ✅ 验证通过！                           │
│  照片验证通过！识别到与任务相关的物体：   │
│  水槽、碗                                │
│                                          │
│  🎁 获得奖励：💰 27金币                  │
│                                          │
│  识别到的物体：                          │
│  [水槽] [碗] [筷子] [洗洁精]             │
└─────────────────────────────────────────┘
```

---

## 🔊 语音提醒

系统使用浏览器内置的语音合成API（Speech Synthesis API）进行语音提醒：

### 提醒时机

1. **启动验证开始**
   - 提醒内容："任务[任务名]启动验证已开始，请拍摄照片"
   - 触发时间：任务开始时间

2. **启动验证通过**
   - 提醒内容："启动验证通过，获得[金币数]金币，任务已开始"
   - 触发时间：验证通过后

3. **启动验证失败**
   - 提醒内容："启动验证失败，扣除[金币数]金币"
   - 触发时间：验证失败后

4. **完成提醒**
   - 提醒内容："任务[任务名]即将完成，请准备拍摄照片进行验证"
   - 触发时间：任务结束前5分钟

5. **完成验证开始**
   - 提醒内容："任务[任务名]完成验证已开始，请拍摄照片"
   - 触发时间：用户点击完成按钮

6. **完成验证通过**
   - 提醒内容："完成验证通过，获得[金币数]金币，任务已完成，总共获得[总金币数]金币"
   - 触发时间：验证通过后

7. **完成验证失败**
   - 提醒内容："完成验证失败，扣除[金币数]金币"
   - 触发时间：验证失败后

---

## 🚀 高级功能

### 1. 任务延期

用户可以在完成提醒后选择延期任务：

```typescript
// 延期任务（延长30分钟）
await updateTask(taskId, {
  scheduledEnd: new Date(task.scheduledEnd.getTime() + 30 * 60000),
});

// 系统会自动重新安排完成提醒
```

### 2. 自定义验证要求

可以为不同类型的任务设置不同的验证要求：

```typescript
// 健身任务
verificationStart: {
  type: 'photo',
  requirement: '拍摄健身房内的照片，需包含健身器材',
  timeout: 60
}

// 学习任务
verificationStart: {
  type: 'photo',
  requirement: '拍摄书桌和学习资料，需显示电脑屏幕或书籍',
  timeout: 60
}

// 工作任务
verificationComplete: {
  type: 'file',
  requirement: '上传项目报告，需为PDF或Word格式',
  timeout: 300,
  acceptedFileTypes: ['.pdf', '.docx', '.doc'],
  maxFileSize: 10
}
```

### 3. 进度检查（可选）

对于长时间任务，可以启用进度检查：

```typescript
enableProgressCheck: true,

// 系统会在任务执行过程中随机触发进度检查
// 如果进度检查失败，任务会被标记为失败，并扣除80%金币
```

---

## 📊 数据统计

系统会记录所有验证相关的数据：

```typescript
interface Task {
  // ... 其他字段
  
  // 验证配置
  verificationStart?: VerificationConfig;
  verificationComplete?: VerificationConfig;
  
  // 验证记录
  actualStart?: Date;           // 实际开始时间
  actualEnd?: Date;             // 实际结束时间
  goldEarned: number;           // 已获得金币
  penaltyGold: number;          // 惩罚金币
  
  // 进度检查记录
  progressChecks: ProgressCheck[];
}
```

可以基于这些数据生成统计报告：
- 验证通过率
- 平均启动延迟
- 金币获得/损失统计
- 任务完成质量分析

---

## 🐛 故障排除

### 问题1：验证界面没有弹出

**可能原因**：
1. 没有在App.tsx中添加GlobalVerificationManager
2. 任务没有配置verificationStart或verificationComplete
3. 任务状态不正确

**解决方法**：
1. 检查App.tsx是否包含`<GlobalVerificationManager />`
2. 检查任务配置是否包含验证配置
3. 检查任务状态是否为'scheduled'

### 问题2：语音提醒没有声音

**可能原因**：
1. 浏览器不支持Speech Synthesis API
2. 系统音量被静音
3. 浏览器权限被拒绝

**解决方法**：
1. 使用Chrome、Edge、Safari等现代浏览器
2. 检查系统音量设置
3. 允许浏览器使用音频权限

### 问题3：验证总是失败

**可能原因**：
1. 百度API配置错误
2. 照片质量太差
3. 照片内容与任务不相关

**解决方法**：
1. 检查百度API密钥是否正确
2. 拍摄清晰的照片
3. 确保照片包含任务相关物品

---

## 📚 相关文档

- [验证功能说明](./验证功能说明.md) - 完整的验证功能文档
- [百度图像识别集成](./百度图像识别集成.md) - 百度API集成指南
- [类型定义](../src/types/index.ts) - 系统类型定义

---

**文档版本**：v1.0  
**最后更新**：2026年2月9日  
**作者**：AI Assistant

