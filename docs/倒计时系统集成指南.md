# 倒计时系统集成指南

## 概述
本文档说明如何将倒计时组件集成到 NewTimelineView.tsx 中，采用最小化改动方式，确保不破坏现有功能。

## 已创建的文件

### 1. 启动验证倒计时组件
- 文件：`src/components/countdown/StartVerificationCountdown.tsx`
- 功能：2分钟倒计时，超时后标记任务（扣30%金币）
- 独立模块，不影响其他任务

### 2. 完成验证倒计时组件
- 文件：`src/components/countdown/FinishVerificationCountdown.tsx`
- 功能：任务时长倒计时，超时后标记任务（0金币）
- 独立模块，不影响其他任务

### 3. 时间轴位置调整工具
- 文件：`src/utils/timelineAdjuster.ts`
- 功能：
  - `adjustTaskStartTime()` - 调整任务启动时间
  - `adjustTaskEndTime()` - 调整任务结束时间
  - `findFreeTimeSlot()` - 查找空闲时段
  - `calculateActualDuration()` - 计算实际耗时

### 4. 金币计算逻辑（已更新）
- 文件：`src/utils/goldCalculator.ts`
- 更新：`calculateActualGoldReward()` 函数
- 规则：
  - 普通任务：实际分钟 × 10
  - 站立任务：实际分钟 × 15
  - 超时：0金币
  - 启动验证超时：扣30%

## 集成步骤

### 步骤1：导入新组件和工具（在文件顶部）

```typescript
// 在 NewTimelineView.tsx 顶部添加导入
import StartVerificationCountdown from '@/components/countdown/StartVerificationCountdown';
import FinishVerificationCountdown from '@/components/countdown/FinishVerificationCountdown';
import { 
  adjustTaskStartTime, 
  adjustTaskEndTime, 
  calculateActualDuration 
} from '@/utils/timelineAdjuster';
import { 
  calculateActualGoldReward, 
  smartDetectTaskPosture 
} from '@/utils/goldCalculator';
```

### 步骤2：添加状态管理（在组件内部，useState 区域）

```typescript
// 在现有 useState 后添加
const [taskStartTimeouts, setTaskStartTimeouts] = useState<Record<string, boolean>>({});
const [taskFinishTimeouts, setTaskFinishTimeouts] = useState<Record<string, boolean>>({});
const [taskActualStartTimes, setTaskActualStartTimes] = useState<Record<string, Date>>({});
```

### 步骤3：添加超时处理函数（在组件内部，其他函数之后）

```typescript
// 启动验证超时处理
const handleStartVerificationTimeout = (taskId: string) => {
  setTaskStartTimeouts(prev => ({ ...prev, [taskId]: true }));
  console.log(`任务 ${taskId} 启动验证超时，完成时将扣除30%金币`);
};

// 完成验证超时处理
const handleFinishVerificationTimeout = (taskId: string) => {
  setTaskFinishTimeouts(prev => ({ ...prev, [taskId]: true }));
  console.log(`任务 ${taskId} 完成超时，将无金币奖励`);
};
```

### 步骤4：修改 handleStartTask 函数（启动任务时）

在现有的 `handleStartTask` 函数中，找到启动验证通过的部分，添加以下代码：

```typescript
// 在启动验证通过后，添加：
const actualStartTime = new Date();
setTaskActualStartTimes(prev => ({ ...prev, [taskId]: actualStartTime }));

// 调整任务在时间轴上的位置
adjustTaskStartTime(taskId, actualStartTime, allTasks, onTaskUpdate);
```

### 步骤5：修改 handleCompleteTask 函数（完成任务时）

在现有的 `handleCompleteTask` 函数中，找到完成验证通过的部分，添加以下代码：

```typescript
// 在完成验证通过后，添加：
const actualEndTime = new Date();
const actualStartTime = taskActualStartTimes[taskId] || new Date(task.startTime);
const actualMinutes = calculateActualDuration(actualStartTime, actualEndTime);

// 调整任务结束时间
adjustTaskEndTime(taskId, actualEndTime, allTasks, onTaskUpdate);

// 计算金币奖励
const posture = smartDetectTaskPosture(task.taskType, task.tags, task.title);
const estimatedMinutes = task.duration || 30;
const startTimeout = taskStartTimeouts[taskId] || false;

const goldResult = calculateActualGoldReward(
  actualMinutes,
  estimatedMinutes,
  posture,
  startTimeout
);

console.log(`任务完成金币计算：`, goldResult);

// 更新金币（调用现有的金币更新逻辑）
// 注意：这里需要根据你现有的金币更新方式来调用
// 例如：useGoldStore 的 addGold 方法
```

### 步骤6：在任务卡片中添加倒计时组件

在任务卡片的渲染部分，找到任务验证相关的UI，添加倒计时组件：

```typescript
{/* 在任务卡片中，验证按钮下方添加 */}
{taskVerifications[block.id]?.enabled && (
  <>
    {/* 启动验证倒计时 - 仅在未启动时显示 */}
    {taskVerifications[block.id]?.status === 'pending' && (
      <StartVerificationCountdown
        taskId={block.id}
        onTimeout={handleStartVerificationTimeout}
        onComplete={() => {}}
        keywords={taskVerifications[block.id]?.keywords || []}
        isStarted={taskVerifications[block.id]?.status === 'started'}
      />
    )}
    
    {/* 完成验证倒计时 - 仅在已启动未完成时显示 */}
    {taskVerifications[block.id]?.status === 'started' && (
      <FinishVerificationCountdown
        taskId={block.id}
        estimatedMinutes={block.duration || 30}
        onTimeout={handleFinishVerificationTimeout}
        keywords={taskVerifications[block.id]?.keywords || []}
        isCompleted={block.isCompleted || false}
        startTime={taskActualStartTimes[block.id] || new Date(block.startTime)}
      />
    )}
  </>
)}
```

## 测试清单

### 1. 基础功能测试
- [ ] 创建普通任务，检查是否正常显示
- [ ] 创建站立任务，检查是否正常显示
- [ ] 完成任务，检查金币计算是否正确

### 2. 启动验证倒计时测试
- [ ] 启用任务验证，检查是否显示2分钟倒计时
- [ ] 在2分钟内完成启动验证，检查倒计时是否消失
- [ ] 超过2分钟完成启动验证，检查是否标记超时
- [ ] 完成超时任务，检查金币是否扣除30%

### 3. 完成验证倒计时测试
- [ ] 完成启动验证后，检查是否显示任务时长倒计时
- [ ] 在预计时间内完成任务，检查金币是否全额
- [ ] 超过预计时间完成任务，检查金币是否为0

### 4. 时间轴调整测试
- [ ] 提前启动任务，检查时间轴位置是否调整
- [ ] 检查冲突任务是否自动下移
- [ ] 完成任务，检查实际时长是否正确记录

### 5. 边界情况测试
- [ ] 创建0分钟任务，检查是否报错
- [ ] 创建超长任务（如1000分钟），检查是否正常
- [ ] 快速连续点击启动/完成按钮，检查是否有异常

## 回滚方案

如果集成后出现问题，可以快速回滚：

```bash
# 回滚到当前版本
git reset --hard 1f3fec6

# 或者只删除新增的文件
rm src/components/countdown/StartVerificationCountdown.tsx
rm src/components/countdown/FinishVerificationCountdown.tsx
rm src/utils/timelineAdjuster.ts

# 恢复 goldCalculator.ts
git checkout HEAD -- src/utils/goldCalculator.ts
```

## 注意事项

1. **不要修改现有函数的签名**：只在函数内部添加新逻辑
2. **使用条件渲染**：倒计时组件只在特定条件下显示
3. **添加错误处理**：所有新增代码都包含参数校验
4. **保持独立性**：新组件不依赖现有组件的内部状态
5. **测试充分**：每次修改后都要测试基础功能是否正常

## 下一步

完成集成后，建议：
1. 提交代码前先在本地充分测试
2. 创建新的 git 分支进行开发
3. 逐步集成，每完成一个功能就测试一次
4. 保留详细的日志，方便调试

## 联系方式

如有问题，请查看：
- 金币计算逻辑：`src/utils/goldCalculator.ts`
- 时间轴调整逻辑：`src/utils/timelineAdjuster.ts`
- 倒计时组件：`src/components/countdown/`





