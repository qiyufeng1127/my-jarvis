# 标签与时间轴交互修复说明

## 问题描述

用户反馈：在时间轴上完成任务后，标签管理器中的标签数据（使用次数、时长）没有更新。

## 问题原因

在 `NewTimelineView.tsx` 组件中，任务完成时只更新了任务状态，但**没有调用标签store的 `recordTagUsage` 方法**来记录标签的使用数据。

## 修复内容

### 1. 导入标签Store

在 `src/components/calendar/NewTimelineView.tsx` 文件中添加了标签store的导入：

```typescript
import { useTagStore } from '@/stores/tagStore';
```

### 2. 使用标签Store的方法

在组件中添加了 `recordTagUsage` 方法的引用：

```typescript
// 使用标签系统
const { recordTagUsage } = useTagStore();
```

### 3. 在任务完成时记录标签使用

#### 场景1：带验证的任务完成

在 `handleVerificationImage` 函数中，当任务完成验证通过后，添加了标签使用记录：

```typescript
// 修正任务结束时间
onTaskUpdate(taskId, { 
  status: 'completed', 
  isCompleted: true,
  scheduledEnd: now.toISOString(),
});

// 记录标签使用时长
if (task.tags && task.tags.length > 0) {
  task.tags.forEach(tagName => {
    recordTagUsage(tagName, taskId, task.title, actualDuration);
    console.log(`📊 记录标签使用: ${tagName} - ${actualDuration}分钟`);
  });
}
```

#### 场景2：无需验证的任务完成

在 `handleCompleteTask` 函数中，当任务直接完成时，添加了标签使用记录：

```typescript
onTaskUpdate(taskId, { status: 'completed' });

// 记录标签使用时长
if (task.tags && task.tags.length > 0) {
  const duration = task.durationMinutes || 60;
  task.tags.forEach(tagName => {
    recordTagUsage(tagName, taskId, task.title, duration);
    console.log(`📊 记录标签使用: ${tagName} - ${duration}分钟`);
  });
}
```

## 修复效果

修复后，当用户在时间轴上完成任务时：

1. ✅ **标签使用次数会增加** - 每完成一个带标签的任务，该标签的 `usageCount` 会 +1
2. ✅ **标签总时长会累加** - 标签的 `totalDuration` 会增加任务的实际时长
3. ✅ **标签最后使用时间会更新** - 标签的 `lastUsedAt` 会更新为当前时间
4. ✅ **时长记录会保存** - 在 `durationRecords` 中会保存详细的使用记录

## 数据流程

```
用户完成任务
    ↓
NewTimelineView.handleCompleteTask()
    ↓
recordTagUsage(tagName, taskId, taskTitle, duration)
    ↓
TagStore 更新标签数据：
  - usageCount +1
  - totalDuration += duration
  - lastUsedAt = now
  - durationRecords.push(新记录)
    ↓
TagManagerV2 显示更新后的数据
```

## 测试建议

1. 创建一个带标签的任务（例如：标签为"日常"和"家务"）
2. 设置任务时长为5分钟
3. 在时间轴上完成该任务
4. 打开标签管理器，检查：
   - "日常"标签的使用次数是否 +1
   - "日常"标签的总时长是否增加了5分钟
   - "家务"标签的使用次数是否 +1
   - "家务"标签的总时长是否增加了5分钟

## 注意事项

- 标签数据会自动保存到 localStorage（通过 zustand persist 中间件）
- 如果任务有多个标签，每个标签都会记录相同的时长
- 控制台会输出标签记录日志，方便调试：`📊 记录标签使用: 标签名 - X分钟`

## 相关文件

- `src/components/calendar/NewTimelineView.tsx` - 时间轴视图组件（已修复）
- `src/stores/tagStore.ts` - 标签数据管理
- `src/components/tags/TagManagerV2.tsx` - 标签管理器界面

---

修复完成时间：2026-02-09







