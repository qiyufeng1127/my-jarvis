# ä¹ æƒ¯ç½å¤´ç³»ç»Ÿ - æŠ€æœ¯å®ç°æ–‡æ¡£

## ğŸ“ æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ types/
â”‚   â””â”€â”€ habitTypes.ts                    # ç±»å‹å®šä¹‰
â”œâ”€â”€ stores/
â”‚   â””â”€â”€ habitCanStore.ts                 # çŠ¶æ€ç®¡ç†
â”œâ”€â”€ services/
â”‚   â””â”€â”€ habitMonitorService.ts           # ç›‘æ§æœåŠ¡
â””â”€â”€ components/
    â””â”€â”€ habits/
        â”œâ”€â”€ HabitCanModule.tsx           # ä¸»æ¨¡å—ï¼ˆå…¥å£ï¼‰
        â”œâ”€â”€ HabitCanCalendar.tsx         # ç½å¤´æ—¥å†
        â”œâ”€â”€ CanDetailModal.tsx           # ç½å¤´è¯¦æƒ…å¼¹çª—
        â”œâ”€â”€ HabitRuleSettings.tsx        # è§„åˆ™è®¾ç½®å¼¹çª—
        â””â”€â”€ CustomizeHabitModal.tsx      # è‡ªå®šä¹‰ä¹ æƒ¯å¼¹çª—
```

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. æ•°æ®æ¨¡å‹

#### BadHabitï¼ˆåä¹ æƒ¯ï¼‰
```typescript
interface BadHabit {
  id: string;
  name: string;
  emoji: string;
  isPreset: boolean;        // æ˜¯å¦ä¸ºé¢„è®¾ä¹ æƒ¯
  enabled: boolean;         // æ˜¯å¦å¯ç”¨
  rule: HabitRule;          // ç›‘æ§è§„åˆ™
  createdAt: Date;
  updatedAt: Date;
}
```

#### HabitRuleï¼ˆè§„åˆ™ï¼‰
```typescript
interface HabitRule {
  id: string;
  type: RuleType;           // è§„åˆ™ç±»å‹
  enabled: boolean;
  
  // æ—¶é—´é˜ˆå€¼è§„åˆ™
  timeThreshold?: {
    time: string;           // HH:mm
    comparison: 'before' | 'after';
    checkType: 'first_event' | 'last_event';
  };
  
  // å…³é”®è¯è§„åˆ™
  keywordRule?: {
    keywords: string[];
    matchType: 'any' | 'all';
    timeRange?: { start: string; end: string };
    shouldExist: boolean;
  };
  
  // ä»»åŠ¡çŠ¶æ€è§„åˆ™
  taskStatusRule?: {
    statusType: 'start_timeout' | 'completion_timeout';
    countPerOccurrence?: number;
  };
}
```

#### HabitOccurrenceï¼ˆå‘ç”Ÿè®°å½•ï¼‰
```typescript
interface HabitOccurrence {
  id: string;
  habitId: string;
  date: string;             // YYYY-MM-DD
  count: number;            // å½“å¤©å‘ç”Ÿæ¬¡æ•°
  details: HabitOccurrenceDetail[];
  isManual: boolean;        // æ˜¯å¦æ‰‹åŠ¨æ·»åŠ 
}

interface HabitOccurrenceDetail {
  time: string;             // HH:mm
  reason: string;           // è§¦å‘åŸå› 
  relatedTaskId?: string;   // å…³è”ä»»åŠ¡ID
}
```

#### CanDataï¼ˆç½å¤´æ•°æ®ï¼‰
```typescript
interface CanData {
  date: string;             // YYYY-MM-DD
  totalCount: number;       // æ€»æ¬¡æ•°
  habits: {
    habitId: string;
    emoji: string;
    count: number;
  }[];
  colorLevel: 'green' | 'yellow' | 'red';
}
```

### 2. çŠ¶æ€ç®¡ç†ï¼ˆhabitCanStoreï¼‰

#### æ ¸å¿ƒæ–¹æ³•

**åˆå§‹åŒ–**
```typescript
initializePresets(): void
// åˆå§‹åŒ– 6 ä¸ªé¢„è®¾åä¹ æƒ¯
```

**ä¹ æƒ¯ç®¡ç†**
```typescript
createHabit(habit): BadHabit
updateHabit(id, updates): void
deleteHabit(id): void
toggleHabit(id, enabled): void
```

**è®°å½•ç®¡ç†**
```typescript
recordOccurrence(habitId, date, detail): void
recordManualOccurrence(habitId, date, count, reason): void
deleteOccurrence(habitId, date): void
```

**æŸ¥è¯¢æ–¹æ³•**
```typescript
getHabitById(id): BadHabit | undefined
getOccurrencesByDate(date): HabitOccurrence[]
getOccurrencesByDateRange(start, end): HabitOccurrence[]
getCanData(date): CanData
getMonthCanData(year, month): CanData[]
getMostFrequentHabit(start, end): { habit, count } | null
```

#### æŒä¹…åŒ–

ä½¿ç”¨ Zustand persist ä¸­é—´ä»¶ï¼š
- å­˜å‚¨é”®ï¼š`manifestos-habit-can-storage`
- ç‰ˆæœ¬ï¼š1
- è‡ªåŠ¨æ¢å¤æ—¥æœŸå¯¹è±¡
- åˆå§‹åŒ–æ—¶åŠ è½½é¢„è®¾ä¹ æƒ¯

### 3. ç›‘æ§æœåŠ¡ï¼ˆhabitMonitorServiceï¼‰

#### æœåŠ¡ç”Ÿå‘½å‘¨æœŸ

```typescript
initialize()    // å¯åŠ¨æœåŠ¡
destroy()       // åœæ­¢æœåŠ¡
```

#### ç›‘æ§æœºåˆ¶

**å®æ—¶ç›‘æ§ï¼ˆæ¯åˆ†é’Ÿï¼‰**
- æ£€æŸ¥ä»»åŠ¡çŠ¶æ€è§„åˆ™ï¼ˆæ‹–å»¶ã€ä½æ•ˆç‡ï¼‰
- è®°å½•è¶…æ—¶äº‹ä»¶

**æ¯æ—¥ç»“ç®—ï¼ˆ00:01ï¼‰**
- æ£€æŸ¥æ—¶é—´é˜ˆå€¼è§„åˆ™ï¼ˆç†¬å¤œã€æ™šèµ·ï¼‰
- æ£€æŸ¥å…³é”®è¯è§„åˆ™ï¼ˆç‚¹å¤–å–ã€ä¸åƒåˆé¥­ï¼‰
- ç”Ÿæˆå½“æ—¥ç»Ÿè®¡

**æ‰‹åŠ¨ç»“ç®—**
```typescript
settlementForDate(date: Date): Promise<void>
// è¡¥ç®—æŒ‡å®šæ—¥æœŸçš„æ•°æ®
```

#### è§„åˆ™æ£€æŸ¥é€»è¾‘

**æ—¶é—´é˜ˆå€¼è§„åˆ™**
```typescript
checkTimeThresholdRule(habit, tasks, date)
1. æ‰¾åˆ°ç¬¬ä¸€ä¸ª/æœ€åä¸€ä¸ªä»»åŠ¡
2. è·å–ä»»åŠ¡æ—¶é—´
3. ä¸é˜ˆå€¼æ¯”è¾ƒ
4. è®°å½•è¿è§„
```

**å…³é”®è¯è§„åˆ™**
```typescript
checkKeywordRule(habit, tasks, date)
1. è¿‡æ»¤æ—¶é—´èŒƒå›´å†…çš„ä»»åŠ¡
2. æ£€æŸ¥å…³é”®è¯åŒ¹é…
3. æ ¹æ® shouldExist åˆ¤æ–­
4. è®°å½•ç»“æœ
```

**ä»»åŠ¡çŠ¶æ€è§„åˆ™**
```typescript
checkTaskStatusRule(habit)
1. è·å–ä»Šæ—¥ä»»åŠ¡
2. æ£€æŸ¥è¶…æ—¶çŠ¶æ€
3. æŒ‰è§„åˆ™è®°å½•æ¬¡æ•°
```

### 4. ç»„ä»¶è®¾è®¡

#### HabitCanModuleï¼ˆä¸»æ¨¡å—ï¼‰
- åˆå§‹åŒ–é¢„è®¾ä¹ æƒ¯
- å¯åŠ¨ç›‘æ§æœåŠ¡
- ç®¡ç†å¼¹çª—çŠ¶æ€
- åè°ƒå­ç»„ä»¶

#### HabitCanCalendarï¼ˆæ—¥å†ï¼‰
- æ˜¾ç¤ºæœˆåº¦ç½å¤´ç½‘æ ¼
- è®¡ç®—ç½å¤´é¢œè‰²
- å¤„ç†æœˆä»½åˆ‡æ¢
- æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯

**å…³é”®è®¡ç®—**
```typescript
// ç½å¤´é¢œè‰²
getCanColor(colorLevel) {
  if (colorLevel === 'green') return æµ…ç»¿è‰²;
  if (colorLevel === 'yellow') return æµ…é»„è‰²;
  return æµ…çº¢è‰²;
}

// æ—¥å†ç½‘æ ¼ï¼ˆåŒ…å«ç©ºç™½å ä½ï¼‰
const firstDayWeekday = getWeekday(firstDate);
const emptySlots = Array(firstDayWeekday).fill(null);
const grid = [...emptySlots, ...canDataList];
```

#### CanDetailModalï¼ˆè¯¦æƒ…å¼¹çª—ï¼‰
- æ˜¾ç¤ºå½“æ—¥æ‰€æœ‰åä¹ æƒ¯
- å±•ç¤ºè§¦å‘åŸå› 
- æ”¯æŒåˆ é™¤æ‰‹åŠ¨è®°å½•

#### HabitRuleSettingsï¼ˆè§„åˆ™è®¾ç½®ï¼‰
- åˆ—è¡¨æ˜¾ç¤ºæ‰€æœ‰ä¹ æƒ¯
- å¯ç”¨/ç¦ç”¨å¼€å…³
- ç¼–è¾‘è§„åˆ™å‚æ•°
- åˆ é™¤è‡ªå®šä¹‰ä¹ æƒ¯

#### CustomizeHabitModalï¼ˆè‡ªå®šä¹‰å¼¹çª—ï¼‰
- è¾“å…¥åç§°å’Œ emoji
- é€‰æ‹©è§„åˆ™ç±»å‹
- é…ç½®è§„åˆ™å‚æ•°
- åˆ›å»ºæ–°ä¹ æƒ¯

## ğŸ”„ æ•°æ®æµ

### è‡ªåŠ¨è®°å½•æµç¨‹

```
1. ç”¨æˆ·åˆ›å»º/å®Œæˆä»»åŠ¡
   â†“
2. taskStore æ›´æ–°ä»»åŠ¡çŠ¶æ€
   â†“
3. habitMonitorService æ£€æµ‹åˆ°å˜åŒ–
   â†“
4. æ‰§è¡Œè§„åˆ™æ£€æŸ¥
   â†“
5. è°ƒç”¨ habitCanStore.recordOccurrence()
   â†“
6. æ›´æ–° occurrences æ•°ç»„
   â†“
7. æŒä¹…åŒ–åˆ° localStorage
   â†“
8. UI è‡ªåŠ¨æ›´æ–°ï¼ˆZustand å“åº”å¼ï¼‰
```

### æ‰‹åŠ¨è®°å½•æµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡»ç½å¤´è¯¦æƒ…
   â†“
2. æ‰“å¼€ CanDetailModal
   â†“
3. ç”¨æˆ·æ‰‹åŠ¨æ·»åŠ è®°å½•
   â†“
4. è°ƒç”¨ habitCanStore.recordManualOccurrence()
   â†“
5. æ ‡è®° isManual = true
   â†“
6. æŒä¹…åŒ–å¹¶æ›´æ–° UI
```

### è§„åˆ™ç¼–è¾‘æµç¨‹

```
1. ç”¨æˆ·æ‰“å¼€è§„åˆ™è®¾ç½®
   â†“
2. é€‰æ‹©è¦ç¼–è¾‘çš„ä¹ æƒ¯
   â†“
3. ä¿®æ”¹è§„åˆ™å‚æ•°
   â†“
4. è°ƒç”¨ habitCanStore.updateHabit()
   â†“
5. è§„åˆ™ç«‹å³ç”Ÿæ•ˆ
   â†“
6. ä¸‹æ¬¡æ£€æŸ¥æ—¶ä½¿ç”¨æ–°è§„åˆ™
```

## ğŸ¨ UI è®¾è®¡è¦ç‚¹

### ç½å¤´æ ·å¼
```css
/* ç½å¤´ä¸»ä½“ */
.can {
  aspect-ratio: 1;
  border-radius: 1rem;
  position: relative;
  transition: transform 0.2s;
}

.can:hover {
  transform: scale(1.05);
}

/* ç½å¤´ç›– */
.can-lid {
  position: absolute;
  top: 0;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 2rem;
  height: 0.5rem;
  border-radius: 9999px;
  background: rgba(255,255,255,0.2);
}
```

### é¢œè‰²è®¡ç®—
```typescript
const getCanColor = (colorLevel: 'green' | 'yellow' | 'red') => {
  if (colorLevel === 'green') {
    return isDark ? '#1a4d2e' : '#d4f4dd';
  }
  if (colorLevel === 'yellow') {
    return isDark ? '#4d3d1a' : '#fff4d4';
  }
  return isDark ? '#4d1a1a' : '#ffd4d4';
};
```

### å“åº”å¼å¸ƒå±€
- æ—¥å†ç½‘æ ¼ï¼š`grid-cols-7`ï¼ˆ7å¤©ä¸€å‘¨ï¼‰
- ç½å¤´é—´è·ï¼š`gap-3`
- ç§»åŠ¨ç«¯è‡ªé€‚åº”ï¼šå‡å°ç½å¤´å°ºå¯¸

## ğŸ”§ é›†æˆæ–¹å¼

### 1. åœ¨ ModuleComponents.tsx ä¸­å¯¼å‡º

```typescript
import HabitCanModule from '@/components/habits/HabitCanModule';

export function HabitsModule({ isDark, bgColor }) {
  const cardBg = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)';
  const textColor = isDark ? '#ffffff' : '#000000';
  const accentColor = isDark ? 'rgba(255,255,255,0.7)' : '#666666';

  return (
    <div className="h-full overflow-auto p-6" style={{ backgroundColor: bgColor }}>
      <HabitCanModule
        isDark={isDark}
        cardBg={cardBg}
        textColor={textColor}
        accentColor={accentColor}
      />
    </div>
  );
}
```

### 2. åœ¨ CustomizableDashboard ä¸­æ³¨å†Œ

```typescript
const availableModules = [
  // ...
  {
    id: 'habits',
    type: 'habits',
    title: 'åä¹ æƒ¯',
    icon: <span className="text-2xl">âš ï¸</span>,
    defaultColor: '#AC0327',
    component: HabitsModule,
  },
  // ...
];
```

### 3. åœ¨ MobileLayout ä¸­æ·»åŠ 

```typescript
const ALL_NAV_ITEMS = [
  // ...
  { 
    id: 'habits', 
    label: 'ä¹ æƒ¯', 
    icon: 'âš ï¸', 
    color: 'green', 
    component: HabitsModule 
  },
  // ...
];
```

## ğŸ§ª æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•
- Store æ–¹æ³•æµ‹è¯•
- è§„åˆ™æ£€æŸ¥é€»è¾‘æµ‹è¯•
- æ—¥æœŸæ ¼å¼åŒ–æµ‹è¯•

### é›†æˆæµ‹è¯•
- åˆ›å»ºä¹ æƒ¯ â†’ è®°å½• â†’ æŸ¥è¯¢æµç¨‹
- è§„åˆ™è§¦å‘ â†’ è‡ªåŠ¨è®°å½•æµç¨‹
- æ‰‹åŠ¨æ·»åŠ  â†’ åˆ é™¤æµç¨‹

### E2E æµ‹è¯•
- å®Œæ•´ç”¨æˆ·æµç¨‹
- è·¨æ—¥æœŸæ•°æ®ä¸€è‡´æ€§
- æŒä¹…åŒ–æ¢å¤æµ‹è¯•

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

1. **useMemo ç¼“å­˜è®¡ç®—**
   - æœˆåº¦ç½å¤´æ•°æ®
   - ç»Ÿè®¡ä¿¡æ¯

2. **æŒ‰éœ€åŠ è½½**
   - å¼¹çª—ç»„ä»¶æ‡’åŠ è½½
   - å†å²æ•°æ®åˆ†é¡µ

3. **é˜²æŠ–èŠ‚æµ**
   - è§„åˆ™æ£€æŸ¥é—´éš”æ§åˆ¶
   - UI æ›´æ–°æ‰¹å¤„ç†

## ğŸ“ ç»´æŠ¤å»ºè®®

1. **å®šæœŸæ¸…ç†æ—§æ•°æ®**
   - ä¿ç•™æœ€è¿‘ 3 ä¸ªæœˆæ•°æ®
   - å¯¼å‡ºå†å²æ•°æ®å¤‡ä»½

2. **è§„åˆ™ä¼˜åŒ–**
   - æ ¹æ®ç”¨æˆ·åé¦ˆè°ƒæ•´é»˜è®¤é˜ˆå€¼
   - æ·»åŠ æ›´å¤šé¢„è®¾ä¹ æƒ¯

3. **åŠŸèƒ½æ‰©å±•**
   - ä¹ æƒ¯è¶‹åŠ¿å›¾è¡¨
   - AI æ™ºèƒ½åˆ†æ
   - ç¤¾äº¤åˆ†äº«åŠŸèƒ½

