# 金币系统和任务流程优化 - 完整实现说明

## 📋 实现概述

本次更新实现了动态金币计算、启动/完成验证倒计时、超时扣罚规则和PWA后台通知功能。

## ✅ 已完成的功能

### 1. 动态金币计算系统

**文件**: `src/utils/goldCalculator.ts`

#### 核心功能
- **基础任务**: 实际耗时 × 10金币/分钟
- **"站起来"任务**: 实际耗时 × 15金币/分钟
- **超时完成**: 0金币（无任何奖励）
- **启动超时**: 扣除30%金币

#### 新增函数
```typescript
calculateActualGoldReward(
  actualMinutes: number,      // 实际耗时
  estimatedMinutes: number,   // 预计时长
  posture: TaskPosture,       // 任务姿势
  startVerificationTimeout: boolean  // 启动验证是否超时
): {
  finalGold: number;   // 最终金币
  baseGold: number;    // 基础金币
  penalty: number;     // 扣罚金币
  reason: string;      // 原因说明
}
```

#### 计算规则
1. **按时完成**: 获得全额金币（实际耗时 × 金币率）
2. **超时完成**: 0金币
3. **启动超时**: 扣除30%金币

### 2. 任务倒计时系统

**文件**: 
- `src/types/index.ts` - 添加倒计时字段
- `src/stores/taskStore.ts` - 倒计时状态管理
- `src/components/calendar/TaskCountdown.tsx` - 倒计时组件

#### Task 类型新增字段
```typescript
interface Task {
  // ... 其他字段
  startVerificationDeadline?: Date;  // 启动验证截止时间（2分钟）
  startVerificationTimeout?: boolean; // 启动验证是否超时
  completionDeadline?: Date;         // 完成验证截止时间（任务总时长）
}
```

#### TaskStore 新增方法
```typescript
// 开始启动验证倒计时（2分钟）
startVerificationCountdown(taskId: string): void

// 完成启动验证
completeStartVerification(taskId: string): void

// 完成任务（计算金币）
completeTask(taskId: string): Promise<void>
```

#### 倒计时组件特性
- **实时更新**: 每秒更新一次
- **颜色变化**: 
  - 绿色：充足时间
  - 橙色：时间紧张
  - 红色：即将超时/已超时
- **自动超时检测**: 超时后自动触发回调

### 3. PWA 后台通知系统

**文件**: `src/services/notificationService.ts`

#### 核心改进
1. **Service Worker 通知**: 优先使用 SW 发送通知，支持后台运行
2. **音效增强**: 提高音量到 0.8，确保能听到
3. **振动反馈**: 添加不同模式的振动
4. **降级策略**: SW 失败时自动降级到普通通知

#### 通知类型
```typescript
// 任务开始通知
notifyTaskStart(taskTitle: string, hasVerification: boolean)
// 振动: [200, 100, 200]

// 任务即将结束通知
notifyTaskEnding(taskTitle: string, minutesLeft: number, hasVerification: boolean)
// 振动: [100, 50, 100, 50, 100] (急促)

// 任务结束通知
notifyTaskEnd(taskTitle: string, hasVerification: boolean)
// 振动: [300, 100, 300] (长振动)
```

#### 后台支持
- ✅ PWA 在后台运行时能收到通知
- ✅ 通知带音效（音量 0.8）
- ✅ 通知带振动反馈
- ✅ 点击通知自动聚焦窗口

### 4. 任务卡片UI优化

**文件**: `src/components/calendar/TaskCountdown.tsx`

#### 倒计时显示
- **启动验证倒计时**: 2分钟倒计时，显示在任务卡片顶部
- **完成验证倒计时**: 任务总时长倒计时，显示在进行中的任务卡片

#### 按钮显示
- **Start 按钮**: 在 `verifying_start` 状态显示
- **完成按钮**: 在 `in_progress` 状态显示

#### 提示文字
- 启动验证: "请拍摄包含【XX关键词】的照片完成启动验证"
- 完成验证: "请在时间内完成任务"

## 📖 使用流程

### 完整任务流程

```
1. 创建任务
   ↓
2. 生成启动验证关键词
   ↓
3. 开始启动验证倒计时（2分钟）
   ├─ 显示倒计时
   ├─ 显示 Start 按钮
   └─ 显示提示文字
   ↓
4. 完成启动验证
   ├─ 如果超时: 标记 startVerificationTimeout = true
   └─ 如果按时: 开始任务
   ↓
5. 任务进行中
   ├─ 显示完成倒计时（任务总时长）
   ├─ 显示完成按钮
   └─ 显示提示文字
   ↓
6. 完成任务
   ├─ 计算实际耗时
   ├─ 判断是否超时
   ├─ 判断启动是否超时
   ├─ 计算最终金币
   │   ├─ 超时完成: 0金币
   │   ├─ 启动超时: 扣30%金币
   │   └─ 按时完成: 全额金币
   └─ 更新金币余额
```

### 金币计算示例

#### 示例1: 按时完成
```
任务: 收拾工作区
预计时长: 10分钟
实际耗时: 8分钟
任务类型: 站立任务（15金币/分钟）

计算:
基础金币 = 8 × 15 = 120金币
启动超时: 否
完成超时: 否
最终金币 = 120金币 ✅
```

#### 示例2: 启动超时
```
任务: 收拾工作区
预计时长: 10分钟
实际耗时: 8分钟
任务类型: 站立任务（15金币/分钟）
启动验证: 超时（超过2分钟）

计算:
基础金币 = 8 × 15 = 120金币
启动超时: 是 → 扣30% = 36金币
最终金币 = 120 - 36 = 84金币 ⚠️
```

#### 示例3: 完成超时
```
任务: 收拾工作区
预计时长: 10分钟
实际耗时: 15分钟（超时）
任务类型: 站立任务（15金币/分钟）

计算:
基础金币 = 15 × 15 = 225金币
完成超时: 是 → 扣除全部金币
最终金币 = 0金币 ❌
```

## 🔧 集成说明

### NewTimelineView.tsx 集成

由于文件较大，已创建集成文档：
- **文档位置**: `docs/NewTimelineView-倒计时集成说明.md`
- **组件位置**: `src/components/calendar/TaskCountdown.tsx`

### 主要集成点

1. **导入组件和方法**
```typescript
import TaskCountdown from './TaskCountdown';
import { useTaskStore } from '@/stores/taskStore';

const { startVerificationCountdown, completeStartVerification, completeTask } = useTaskStore();
```

2. **显示倒计时**
在任务卡片中根据状态显示不同的倒计时

3. **添加按钮**
- Start 按钮: 触发启动验证
- 完成按钮: 调用 completeTask 方法

## 🎯 技术亮点

### 1. 动态金币计算
- 完全基于实际耗时，而非固定值
- 自动判断任务姿势（站立/坐着）
- 智能扣罚规则

### 2. 实时倒计时
- 每秒更新
- 颜色动态变化
- 自动超时检测

### 3. PWA 后台支持
- Service Worker 通知
- 后台音效播放
- 振动反馈
- 降级策略

### 4. 用户体验优化
- 清晰的视觉反馈
- 及时的提示信息
- 流畅的状态转换

## 📝 待完成事项

### NewTimelineView.tsx 集成
需要手动集成倒计时组件到任务卡片中，具体步骤见：
`docs/NewTimelineView-倒计时集成说明.md`

### 测试建议
1. 创建一个短时任务（5分钟）
2. 生成启动验证关键词
3. 观察2分钟倒计时
4. 测试超时和按时两种情况
5. 验证金币计算是否正确

## 🚀 下一步优化

1. **UI集成**: 完成 NewTimelineView.tsx 的倒计时显示
2. **测试**: 全流程测试各种场景
3. **优化**: 根据测试结果调整倒计时和金币规则
4. **文档**: 补充用户使用指南

## 📊 文件变更清单

### 新增文件
- `src/components/calendar/TaskCountdown.tsx` - 倒计时组件
- `docs/NewTimelineView-倒计时集成说明.md` - 集成文档
- `docs/金币系统和任务流程优化说明.md` - 本文档

### 修改文件
- `src/utils/goldCalculator.ts` - 添加动态金币计算
- `src/types/index.ts` - 添加倒计时字段
- `src/stores/taskStore.ts` - 添加倒计时状态管理
- `src/services/notificationService.ts` - 增强后台通知

## 🎉 总结

本次更新实现了完整的动态金币计算和任务流程优化系统，包括：
- ✅ 动态金币计算（基于实际耗时）
- ✅ 启动验证倒计时（2分钟）
- ✅ 完成验证倒计时（任务总时长）
- ✅ 超时扣罚规则（超时0金币，启动超时扣30%）
- ✅ PWA后台通知（音效+振动）
- ✅ 倒计时组件（实时更新+颜色变化）

所有核心功能已实现，只需完成 UI 集成即可投入使用！



