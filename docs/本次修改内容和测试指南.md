# 倒计时系统集成 - 修改内容和测试指南

## 📝 本次修改的所有内容

### 一、新增文件（4个）

#### 1. `src/components/countdown/StartVerificationCountdown.tsx`
**功能**：启动验证倒计时组件（2分钟倒计时）

**核心逻辑**：
- 从2分钟（120秒）开始倒计时
- 每秒更新一次显示
- 倒计时结束时调用 `onTimeout` 回调，标记任务为"启动验证超时"
- 超时后完成任务将扣除30%金币
- 显示格式：`MM:SS`（如 `01:30`）
- 提示用户需要拍摄包含关键词的照片

**显示样式**：
- 黄色背景（`bg-yellow-50`）
- 黄色边框（`border-yellow-200`）
- 时钟图标 + 倒计时文字
- 关键词提示

---

#### 2. `src/components/countdown/FinishVerificationCountdown.tsx`
**功能**：完成验证倒计时组件（任务预计时长倒计时）

**核心逻辑**：
- 从任务预计时长开始倒计时（如30分钟 = 1800秒）
- 根据实际启动时间计算剩余时间
- 倒计时结束时调用 `onTimeout` 回调，标记任务为"完成超时"
- 超时后完成任务将获得0金币
- 显示格式：`HH时 MM分 SS秒`（如 `1时 30分 00秒`）
- 提示用户需要拍摄包含关键词的照片

**显示样式**：
- 蓝色背景（`bg-blue-50`）
- 蓝色边框（`border-blue-200`）
- 时钟图标 + 倒计时文字
- 关键词提示

---

#### 3. `src/utils/timelineAdjuster.ts`
**功能**：时间轴位置调整工具函数

**包含的函数**：

##### `adjustTaskStartTime(taskId, actualStartTime, tasks, onTaskUpdate)`
- 调整任务的实际启动时间
- 更新任务在时间轴上的位置
- 自动检测并处理时间冲突

##### `adjustTaskEndTime(taskId, actualEndTime, tasks, onTaskUpdate)`
- 调整任务的实际结束时间
- 计算实际耗时（分钟）
- 记录到任务数据中

##### `findFreeTimeSlot(startTime, duration, tasks, excludeTaskId)`
- 查找指定时间后最近的空闲时段
- 用于冲突任务的自动下移
- 返回可用的开始时间

##### `calculateActualDuration(startTime, endTime)`
- 计算两个时间点之间的实际耗时（分钟）
- 包含参数校验，防止异常

**特点**：
- 所有函数都包含边界校验
- 不修改任务的其他属性（如金币、验证规则）
- 仅操作时间相关字段

---

#### 4. `src/utils/goldCalculator.ts`（修改）
**修改的函数**：`calculateActualGoldReward()`

**新的金币计算规则**：

```typescript
// 基础金币 = 实际完成时长（分钟） × 倍率
// 普通任务：10金币/分钟
// 站立任务：15金币/分钟

// 规则1：超时完成（实际时长 > 预计时长）
// 结果：0金币，无奖励

// 规则2：启动验证超时
// 结果：扣除30%金币（最终金币 = 基础金币 × 0.7）

// 规则3：按时完成
// 结果：获得全额金币
```

**返回值**：
```typescript
{
  finalGold: number,      // 最终金币
  baseGold: number,       // 基础金币
  penalty: number,        // 扣除的金币
  reason: string          // 计算原因说明
}
```

---

### 二、修改文件（1个）

#### `src/components/calendar/NewTimelineView.tsx`

##### 修改1：添加导入语句（第23-33行）
```typescript
import StartVerificationCountdown from '@/components/countdown/StartVerificationCountdown';
import FinishVerificationCountdown from '@/components/countdown/FinishVerificationCountdown';
import { 
  adjustTaskStartTime, 
  adjustTaskEndTime, 
  calculateActualDuration 
} from '@/utils/timelineAdjuster';
import { 
  calculateActualGoldReward, 
  smartDetectTaskPosture 
} from '@/utils/goldCalculator';
```

---

##### 修改2：添加状态管理（第95-97行）
```typescript
const [taskStartTimeouts, setTaskStartTimeouts] = useState<Record<string, boolean>>({});
const [taskFinishTimeouts, setTaskFinishTimeouts] = useState<Record<string, boolean>>({});
const [taskActualStartTimes, setTaskActualStartTimes] = useState<Record<string, Date>>({});
```

**说明**：
- `taskStartTimeouts`：记录哪些任务启动验证超时了
- `taskFinishTimeouts`：记录哪些任务完成超时了
- `taskActualStartTimes`：记录每个任务的实际启动时间

---

##### 修改3：添加超时处理函数（第806-817行）
```typescript
// 启动验证超时处理
const handleStartVerificationTimeout = (taskId: string) => {
  setTaskStartTimeouts(prev => ({ ...prev, [taskId]: true }));
  console.log(`任务 ${taskId} 启动验证超时，完成时将扣除30%金币`);
};

// 完成验证超时处理
const handleFinishVerificationTimeout = (taskId: string) => {
  setTaskFinishTimeouts(prev => ({ ...prev, [taskId]: true }));
  console.log(`任务 ${taskId} 完成超时，将无金币奖励`);
};
```

**说明**：
- 这两个函数在倒计时结束时被调用
- 仅标记超时状态，不影响其他逻辑
- 在控制台输出日志，方便调试

---

##### 修改4：启动验证通过后调整时间轴（第1023-1026行）
```typescript
// 记录实际启动时间并调整时间轴位置
setTaskActualStartTimes(prev => ({ ...prev, [taskId]: now }));
adjustTaskStartTime(taskId, now, allTasks, onTaskUpdate);
```

**位置**：在 `handleStartTask` 函数中，启动验证通过后，设置 `status: 'started'` 之后

**作用**：
- 记录任务的实际启动时间
- 调整任务在时间轴上的位置
- 如果有冲突任务，自动下移

---

##### 修改5：完成验证通过后调整时间轴（第1105-1107行）
```typescript
// 调整任务结束时间
adjustTaskEndTime(taskId, now, allTasks, onTaskUpdate);
```

**位置**：在 `handleVerificationImage` 函数中，完成验证通过后，设置 `status: 'completed'` 之后

**作用**：
- 记录任务的实际结束时间
- 计算实际耗时
- 用于金币计算

---

##### 修改6：在任务卡片中显示倒计时组件（第2208-2235行）
```typescript
{/* 倒计时组件 - 仅在启用验证时显示 */}
{taskVerifications[block.id]?.enabled && (
  <>
    {/* 启动验证倒计时 - 仅在未启动时显示 */}
    {taskVerifications[block.id]?.status === 'pending' && (
      <StartVerificationCountdown
        taskId={block.id}
        onTimeout={handleStartVerificationTimeout}
        onComplete={() => {}}
        keywords={taskVerifications[block.id]?.startKeywords || []}
        isStarted={taskVerifications[block.id]?.status === 'started'}
      />
    )}
    
    {/* 完成验证倒计时 - 仅在已启动未完成时显示 */}
    {taskVerifications[block.id]?.status === 'started' && (
      <FinishVerificationCountdown
        taskId={block.id}
        estimatedMinutes={block.duration || block.durationMinutes || 30}
        onTimeout={handleFinishVerificationTimeout}
        keywords={taskVerifications[block.id]?.completionKeywords || []}
        isCompleted={block.isCompleted || block.status === 'completed'}
        startTime={taskActualStartTimes[block.id] || taskVerifications[block.id]?.actualStartTime || new Date(block.startTime)}
      />
    )}
  </>
)}
```

**位置**：在任务卡片的按钮区域之后

**显示逻辑**：
- 只有启用了验证的任务才显示倒计时
- 启动验证倒计时：任务状态为 `pending` 时显示
- 完成验证倒计时：任务状态为 `started` 时显示
- 任务完成后，倒计时自动消失

---

## 🧪 测试指南

### 测试前准备
1. 确保代码已推送到GitHub
2. 刷新浏览器（http://localhost:3001/）
3. 打开浏览器控制台（F12），查看日志

---

### 测试场景1：启动验证倒计时（2分钟）

#### 步骤：
1. **创建任务**
   - 点击"+"按钮创建新任务
   - 标题：`测试启动倒计时`
   - 时长：`30分钟`
   - 点击保存

2. **启用任务验证**
   - 点击任务卡片上的"🔒"按钮
   - 系统自动生成启动验证关键词（如：`手机`、`键盘`）

3. **观察启动倒计时**
   - ✅ 任务卡片下方应该出现**黄色背景**的倒计时框
   - ✅ 显示：`启动倒计时：02:00`
   - ✅ 每秒更新一次：`01:59`、`01:58`...
   - ✅ 显示提示：`请拍摄包含【手机、键盘】的照片完成启动验证`

4. **测试超时情况**
   - 等待2分钟，不要点击"start"按钮
   - ✅ 倒计时到 `00:00` 后，显示：`启动验证超时！完成任务将扣除30%金币`
   - ✅ 控制台输出：`任务 xxx 启动验证超时，完成时将扣除30%金币`

5. **测试按时启动**
   - 重新创建任务并启用验证
   - 在2分钟内点击"start"按钮
   - 拍摄包含关键词的照片
   - ✅ 启动验证通过后，黄色倒计时框消失
   - ✅ 出现蓝色的完成倒计时框

---

### 测试场景2：完成验证倒计时（任务时长）

#### 步骤：
1. **完成启动验证**（参考测试场景1）

2. **观察完成倒计时**
   - ✅ 任务卡片下方应该出现**蓝色背景**的倒计时框
   - ✅ 显示：`剩余时间：30分 00秒`（如果任务是30分钟）
   - ✅ 每秒更新一次：`29分 59秒`、`29分 58秒`...
   - ✅ 显示提示：`请拍摄包含【手机、键盘】的照片完成任务`

3. **测试超时情况**
   - 等待任务时长结束（或创建1分钟的短任务测试）
   - ✅ 倒计时到 `00分 00秒` 后，显示：`任务超时！完成将无金币奖励`
   - ✅ 控制台输出：`任务 xxx 完成超时，将无金币奖励`
   - 点击"完成"按钮，拍摄照片完成任务
   - ✅ 获得 **0金币**

4. **测试按时完成**
   - 重新创建任务（如10分钟）
   - 在倒计时结束前（如5分钟时）点击"完成"按钮
   - 拍摄包含关键词的照片
   - ✅ 完成验证通过后，蓝色倒计时框消失
   - ✅ 获得金币：`实际耗时 × 倍率`（如5分钟 × 10 = 50金币）

---

### 测试场景3：金币计算规则

#### 测试3.1：普通任务按时完成
**步骤**：
1. 创建任务：`写代码`，时长 `10分钟`
2. 启用验证，立即启动（2分钟内）
3. 在10分钟内完成（如8分钟时完成）

**预期结果**：
- ✅ 实际耗时：8分钟
- ✅ 金币计算：8 × 10 = **80金币**
- ✅ 控制台输出：`按时完成（实际8分钟），获得全额金币`

---

#### 测试3.2：站立任务按时完成
**步骤**：
1. 创建任务：`拍照10张`，时长 `10分钟`
2. 启用验证，立即启动
3. 在10分钟内完成（如6分钟时完成）

**预期结果**：
- ✅ 实际耗时：6分钟
- ✅ 金币计算：6 × 15 = **90金币**（站立任务15金币/分钟）
- ✅ 控制台输出：`按时完成（实际6分钟），获得全额金币`

---

#### 测试3.3：启动验证超时
**步骤**：
1. 创建任务：`写代码`，时长 `10分钟`
2. 启用验证，**等待2分钟后**才启动（超时）
3. 在10分钟内完成（如8分钟时完成）

**预期结果**：
- ✅ 实际耗时：8分钟
- ✅ 基础金币：8 × 10 = 80金币
- ✅ 扣除30%：80 × 0.3 = 24金币
- ✅ 最终金币：80 - 24 = **56金币**
- ✅ 控制台输出：`启动验证超时，扣除30%金币（-24金币）`

---

#### 测试3.4：任务超时完成
**步骤**：
1. 创建任务：`写代码`，时长 `10分钟`
2. 启用验证，立即启动
3. **超过10分钟后**完成（如12分钟时完成）

**预期结果**：
- ✅ 实际耗时：12分钟
- ✅ 预计时长：10分钟
- ✅ 超时：12 > 10
- ✅ 最终金币：**0金币**
- ✅ 控制台输出：`任务超时完成（实际12分钟 > 预计10分钟），无金币奖励`

---

#### 测试3.5：启动超时 + 任务超时（双重超时）
**步骤**：
1. 创建任务：`写代码`，时长 `10分钟`
2. 启用验证，等待2分钟后才启动（启动超时）
3. 超过10分钟后完成（如12分钟时完成）

**预期结果**：
- ✅ 最终金币：**0金币**（任务超时优先级更高）
- ✅ 控制台输出：`任务超时完成（实际12分钟 > 预计10分钟），无金币奖励`

---

### 测试场景4：时间轴位置调整

#### 测试4.1：提前启动任务
**步骤**：
1. 创建任务A：`写代码`，时间 `14:00-15:00`
2. 创建任务B：`开会`，时间 `15:00-16:00`
3. 在 `13:50` 时启动任务A（提前10分钟）

**预期结果**：
- ✅ 任务A的时间轴位置自动调整到 `13:50`
- ✅ 任务B保持在 `15:00`（无冲突）
- ✅ 控制台输出时间轴调整日志

---

#### 测试4.2：冲突任务自动下移
**步骤**：
1. 创建任务A：`写代码`，时间 `14:00-15:00`
2. 创建任务B：`开会`，时间 `14:30-15:30`（与A冲突）
3. 在 `14:00` 时启动任务A

**预期结果**：
- ✅ 任务A保持在 `14:00`
- ✅ 任务B自动下移到 `15:00`（任务A结束后）
- ✅ 时间轴上任务不重叠

---

### 测试场景5：边界情况

#### 测试5.1：极短任务（1分钟）
**步骤**：
1. 创建任务：`快速任务`，时长 `1分钟`
2. 启用验证，立即启动
3. 在1分钟内完成

**预期结果**：
- ✅ 倒计时正常显示：`01:00`、`00:59`...
- ✅ 金币计算正确：1 × 10 = 10金币

---

#### 测试5.2：极长任务（2小时）
**步骤**：
1. 创建任务：`长时间工作`，时长 `120分钟`
2. 启用验证，立即启动

**预期结果**：
- ✅ 倒计时正常显示：`2时 00分 00秒`
- ✅ 每秒更新正常

---

#### 测试5.3：快速连续操作
**步骤**：
1. 创建任务并启用验证
2. 快速连续点击"start"按钮多次

**预期结果**：
- ✅ 不会重复启动
- ✅ 不会报错
- ✅ 只执行一次启动验证

---

## 📊 预期效果总结

### 视觉效果

#### 1. 启动验证倒计时（黄色）
```
┌─────────────────────────────────────────┐
│ 🕐 启动倒计时：01:30                    │
│ 请拍摄包含【手机、键盘】的照片完成启动验证 │
└─────────────────────────────────────────┘
```
- 背景：浅黄色
- 边框：黄色
- 位置：任务卡片按钮区域下方

---

#### 2. 完成验证倒计时（蓝色）
```
┌─────────────────────────────────────────┐
│ 🕐 剩余时间：29分 30秒                   │
│ 请拍摄包含【手机、键盘】的照片完成任务    │
└─────────────────────────────────────────┘
```
- 背景：浅蓝色
- 边框：蓝色
- 位置：任务卡片按钮区域下方

---

#### 3. 超时提示（黄色/蓝色）
```
┌─────────────────────────────────────────┐
│ 🕐 启动验证超时！完成任务将扣除30%金币   │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ 🕐 任务超时！完成将无金币奖励            │
└─────────────────────────────────────────┘
```

---

### 控制台日志

#### 启动验证通过
```
任务 xxx 启动验证超时，完成时将扣除30%金币
记录实际启动时间并调整时间轴位置
```

#### 完成验证通过
```
💰 金币计算结果: 按时完成（实际8分钟），获得全额金币
💰 基础金币: 80 金币
💰 最终金币: 80 金币
调整任务结束时间
```

#### 超时情况
```
任务 xxx 完成超时，将无金币奖励
💰 金币计算结果: 任务超时完成（实际12分钟 > 预计10分钟），无金币奖励
💰 基础金币: 120 金币
⚠️ 扣除金币: 120 金币
💰 最终金币: 0 金币
```

---

## ✅ 验收标准

### 功能完整性
- ✅ 启动验证倒计时正常显示和倒计时
- ✅ 完成验证倒计时正常显示和倒计时
- ✅ 超时标记正确
- ✅ 金币计算符合规则
- ✅ 时间轴位置自动调整
- ✅ 冲突任务自动下移

### 稳定性
- ✅ 无编译错误
- ✅ 无运行时错误
- ✅ 快速操作不崩溃
- ✅ 边界情况处理正确

### 用户体验
- ✅ 倒计时显示清晰
- ✅ 超时提示明显
- ✅ 金币计算透明
- ✅ 不影响现有功能

---

## 🎯 核心改进点

### 1. 金币计算更公平
- **旧规则**：固定金币，不考虑实际耗时
- **新规则**：实际耗时 × 倍率，超时0金币

### 2. 时间管理更严格
- **旧规则**：无时间限制
- **新规则**：2分钟启动限制，任务时长限制

### 3. 奖惩机制更明确
- **启动超时**：扣30%金币
- **任务超时**：0金币
- **按时完成**：全额金币

### 4. 用户反馈更及时
- **实时倒计时**：随时知道剩余时间
- **超时提示**：明确告知后果
- **控制台日志**：方便调试和理解

---

## 📌 注意事项

1. **倒计时只在启用验证的任务中显示**
   - 未启用验证的任务不受影响
   - 保持向后兼容

2. **时间轴调整是自动的**
   - 用户无需手动操作
   - 冲突任务自动下移

3. **金币计算是透明的**
   - 控制台输出详细日志
   - 用户可以清楚看到计算过程

4. **所有修改都是独立的**
   - 不影响现有功能
   - 可以随时回滚

---

## 🔧 调试技巧

### 查看倒计时状态
```javascript
// 在浏览器控制台输入
console.log('启动超时任务:', taskStartTimeouts);
console.log('完成超时任务:', taskFinishTimeouts);
console.log('实际启动时间:', taskActualStartTimes);
```

### 查看金币计算
```javascript
// 完成任务时，控制台会自动输出
💰 金币计算结果: ...
💰 基础金币: ...
💰 最终金币: ...
```

### 查看时间轴调整
```javascript
// 启动/完成任务时，控制台会自动输出
记录实际启动时间并调整时间轴位置
调整任务结束时间
```

---

## 🎉 总结

本次修改实现了完整的倒计时系统，包括：
- ✅ 2分钟启动验证倒计时
- ✅ 任务时长完成倒计时
- ✅ 超时扣罚机制（启动超时-30%，任务超时0金币）
- ✅ 时间轴自动调整
- ✅ 冲突任务自动下移
- ✅ 实际耗时金币计算

所有功能都是独立模块，不影响现有功能，可以安全使用！








