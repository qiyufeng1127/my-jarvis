# 紧急修复：语音识别和倒计时显示问题

## 🐛 问题描述

### 问题1：语音识别听不到
**现象：**
- 点击免手模式，按钮变绿
- 说话后完全没有反应
- 没有"正在处理"提示
- 没有错误提示

**根本原因：**
- useEffect 依赖项包含 `isListening`，导致每次状态变化都重新初始化识别器
- 识别器被反复创建和销毁，无法正常工作
- 缺少明确的启动成功反馈

### 问题2：倒计时不显示
**现象：**
- 任务到点后没有显示大字倒计时
- 启动验证倒计时（2分钟）不显示
- 完成验证倒计时（任务时长）不显示

**根本原因：**
- NewTimelineView.tsx 中没有导入倒计时组件
- 倒计时组件虽然存在，但没有被使用
- 之前的提交可能被覆盖了

## ✅ 修复方案

### 修复1：语音识别（已完成）

#### 修改文件：`src/components/voice/VoiceControl.tsx`

**关键修改：**

1. **移除 isListening 依赖**
```typescript
// 修改前
useEffect(() => {
  // ...
}, [isOpen, isListening]); // ❌ 错误：会导致重复初始化

// 修改后
useEffect(() => {
  // ...
}, [isOpen]); // ✅ 正确：只在打开时初始化一次
```

2. **添加启动成功反馈**
```typescript
recognition.onstart = () => {
  console.log('✅ 语音识别已启动，麦克风正在监听');
  setResponse('麦克风已启动，请说话...'); // 立即反馈
};
```

3. **增强错误提示**
```typescript
case 'audio-capture':
  errorMessage = '无法访问麦克风，请检查麦克风权限。点击浏览器地址栏的麦克风图标允许访问';
  setResponse(errorMessage);
  speak(errorMessage); // 语音告知
  break;
```

4. **添加详细日志**
```typescript
recognition.onresult = (event: any) => {
  console.log('🎤 收到语音识别结果'); // 确认收到数据
  // ...
  if (finalTranscript) {
    console.log('🎤 最终识别:', finalTranscript);
    setResponse('正在处理您的指令...'); // 立即反馈
  }
};
```

### 修复2：倒计时显示（需要完成）

#### 需要修改的文件：`src/components/calendar/NewTimelineView.tsx`

**步骤1：添加导入**
在文件顶部添加：
```typescript
import StartVerificationCountdown from '@/components/countdown/StartVerificationCountdown';
import FinishVerificationCountdown from '@/components/countdown/FinishVerificationCountdown';
```

**步骤2：添加状态管理**
在组件内部添加：
```typescript
const [taskStartTimeouts, setTaskStartTimeouts] = useState<Record<string, boolean>>({});
const [taskFinishTimeouts, setTaskFinishTimeouts] = useState<Record<string, boolean>>({});
const [taskActualStartTimes, setTaskActualStartTimes] = useState<Record<string, Date>>({});
```

**步骤3：添加超时处理函数**
```typescript
// 启动验证超时处理
const handleStartVerificationTimeout = (taskId: string) => {
  setTaskStartTimeouts(prev => ({ ...prev, [taskId]: true }));
  console.log(`任务 ${taskId} 启动验证超时，完成时将扣除30%金币`);
};

// 完成验证超时处理
const handleFinishVerificationTimeout = (taskId: string) => {
  setTaskFinishTimeouts(prev => ({ ...prev, [taskId]: true }));
  console.log(`任务 ${taskId} 完成超时，将无金币奖励`);
};
```

**步骤4：在任务卡片中渲染倒计时**
找到任务卡片的渲染位置，添加：
```typescript
{/* 倒计时组件 - 显示在任务卡片中 */}
{task.status === 'waiting_start' && task.startVerificationDeadline && (
  <StartVerificationCountdown
    taskId={task.id}
    onTimeout={handleStartVerificationTimeout}
    onComplete={() => {}}
    keywords={task.verificationStart?.requirement?.split('、') || []}
    isStarted={false}
  />
)}

{task.status === 'in_progress' && task.completionDeadline && (
  <FinishVerificationCountdown
    taskId={task.id}
    estimatedMinutes={task.durationMinutes}
    onTimeout={handleFinishVerificationTimeout}
    keywords={task.verificationComplete?.requirement?.split('、') || []}
    isCompleted={false}
    startTime={task.actualStart || new Date()}
  />
)}
```

## 🧪 测试步骤

### 测试语音识别

1. **打开免手模式**
   - 点击免手模式按钮
   - ✅ 按钮变绿
   - ✅ 显示"麦克风已启动，请说话..."
   - ✅ 控制台输出："✅ 语音识别已启动，麦克风正在监听"

2. **说话测试**
   - 说："下个任务是什么"
   - ✅ 显示识别的文字："下个任务是什么"
   - ✅ 显示："正在处理您的指令..."
   - ✅ 控制台输出："🎤 收到语音识别结果"
   - ✅ 控制台输出："🎤 最终识别: 下个任务是什么"
   - ✅ 显示回复并语音播报

3. **测试错误处理**
   - 不说话，等待10秒
   - ✅ 显示："没有检测到语音，请再说一遍"
   - ✅ 语音播报错误信息

4. **测试麦克风权限**
   - 如果没有权限
   - ✅ 显示："无法访问麦克风，请检查麦克风权限..."
   - ✅ 语音播报错误信息

### 测试倒计时显示

1. **创建任务并启用验证**
   - 创建任务：12:38 吃饭，30分钟
   - 启用验证

2. **等待任务开始时间**
   - 到12:38时
   - ✅ 任务卡片变大
   - ✅ 显示黄色启动倒计时："启动倒计时：02:00"
   - ✅ 每秒更新

3. **完成启动验证**
   - 点击启动按钮
   - 拍照验证
   - ✅ 黄色倒计时消失
   - ✅ 显示蓝色完成倒计时："剩余时间：30分 00秒"
   - ✅ 每秒更新

4. **测试超时**
   - 等待2分钟不启动
   - ✅ 显示："启动验证超时！完成任务将扣除30%金币"

## 📝 当前状态

### ✅ 已完成
- [x] 修复语音识别初始化问题
- [x] 添加语音识别反馈
- [x] 增强错误提示
- [x] 添加详细日志
- [x] 已提交到 Git

### ⏳ 待完成
- [ ] 在 NewTimelineView 中导入倒计时组件
- [ ] 添加倒计时状态管理
- [ ] 在任务卡片中渲染倒计时
- [ ] 测试倒计时功能
- [ ] 提交到 Git

## 🚨 紧急程度

**语音识别：** 🔴 已修复，需要测试
**倒计时显示：** 🔴 紧急，需要立即修复

## 💡 为什么会出现这些问题？

### 语音识别问题
1. React useEffect 的依赖项管理不当
2. 每次 isListening 变化都重新创建识别器
3. 导致识别器无法正常工作

### 倒计时问题
1. 代码可能在合并时丢失
2. 或者在某次提交中被覆盖
3. 倒计时组件存在但没有被使用

## 🎯 下一步行动

1. **立即测试语音识别**
   - 刷新浏览器
   - 打开免手模式
   - 说话测试
   - 查看控制台日志

2. **修复倒计时显示**
   - 按照上面的步骤修改 NewTimelineView.tsx
   - 测试倒计时功能
   - 提交代码

3. **全面测试**
   - 测试所有语音指令
   - 测试所有倒计时场景
   - 确保没有其他问题

---

**修复时间：** 2026-02-10
**修复人员：** AI Assistant
**状态：** 语音识别已修复，倒计时待修复

