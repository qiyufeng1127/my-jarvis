# 🚨 任务卡片验证界面修复指南

## 📋 需求说明

### 启动验证期间（2分钟倒计时）
任务卡片变大，只显示：
- ✅ 任务标题
- ✅ "请完成启动验证"
- ✅ 倒计时（02:00 格式）
- ✅ START 按钮
- ❌ 隐藏所有其他按钮和信息

### 完成验证期间（任务时长倒计时）
任务卡片变大，只显示：
- ✅ 任务标题
- ✅ "距离任务完成"
- ✅ 倒计时（29分30秒 格式）
- ✅ COMPLETE 按钮
- ❌ 隐藏所有其他按钮和信息

### 修复验证状态反复跳回的bug
- ✅ 验证状态持久化到 localStorage
- ✅ 防止状态被重置

---

## 🔧 修复步骤

### 步骤1：打开文件
打开 `src/components/calendar/NewTimelineView.tsx`

### 步骤2：添加导入（在文件顶部）
找到其他 import 语句，添加：

```typescript
import TaskCardVerification from '@/components/verification/FullScreenVerification';
```

### 步骤3：添加状态管理（在组件内部）
找到其他 useState 的位置，添加：

```typescript
// 验证状态管理 - 持久化到 localStorage
const [verificationStates, setVerificationStates] = useState<Record<string, {
  status: 'pending' | 'started' | 'completed';
  startTime?: Date;
  actualStartTime?: Date;
}>>(() => {
  // 从 localStorage 加载
  const saved = localStorage.getItem('task_verification_states');
  if (saved) {
    try {
      const parsed = JSON.parse(saved);
      // 转换日期字符串为 Date 对象
      Object.keys(parsed).forEach(key => {
        if (parsed[key].startTime) {
          parsed[key].startTime = new Date(parsed[key].startTime);
        }
        if (parsed[key].actualStartTime) {
          parsed[key].actualStartTime = new Date(parsed[key].actualStartTime);
        }
      });
      return parsed;
    } catch (e) {
      console.error('加载验证状态失败:', e);
    }
  }
  return {};
});

// 保存验证状态到 localStorage
useEffect(() => {
  localStorage.setItem('task_verification_states', JSON.stringify(verificationStates));
}, [verificationStates]);
```

### 步骤4：添加验证状态更新函数

```typescript
// 更新验证状态
const updateVerificationState = (taskId: string, updates: Partial<{
  status: 'pending' | 'started' | 'completed';
  startTime?: Date;
  actualStartTime?: Date;
}>) => {
  setVerificationStates(prev => ({
    ...prev,
    [taskId]: {
      ...prev[taskId],
      ...updates,
    }
  }));
  console.log(`✅ 更新任务 ${taskId} 验证状态:`, updates);
};

// 获取验证状态
const getVerificationState = (taskId: string) => {
  return verificationStates[taskId] || { status: 'pending' };
};
```

### 步骤5：修改启动验证处理函数
找到 `handleStartTask` 或类似的启动验证函数，修改为：

```typescript
const handleStartVerification = async (taskId: string) => {
  console.log('🚀 开始启动验证:', taskId);
  
  // 更新状态为 started
  updateVerificationState(taskId, {
    status: 'started',
    actualStartTime: new Date(),
  });
  
  // 打开验证弹窗（拍照）
  // ... 你的验证逻辑
  
  // 验证成功后，不要重置状态！
  console.log('✅ 启动验证成功');
};
```

### 步骤6：修改完成验证处理函数
找到 `handleCompleteTask` 或类似的完成验证函数，修改为：

```typescript
const handleCompleteVerification = async (taskId: string) => {
  console.log('🏁 开始完成验证:', taskId);
  
  // 更新状态为 completed
  updateVerificationState(taskId, {
    status: 'completed',
  });
  
  // 打开验证弹窗（拍照）
  // ... 你的验证逻辑
  
  // 验证成功后，标记任务完成
  console.log('✅ 完成验证成功');
};
```

### 步骤7：修改任务卡片渲染逻辑
找到任务卡片的渲染位置，**完全替换**为：

```typescript
{/* 任务卡片渲染 */}
{tasks.map(task => {
  const verificationState = getVerificationState(task.id);
  const now = new Date();
  const taskStart = task.scheduledStart ? new Date(task.scheduledStart) : null;
  const taskEnd = task.scheduledEnd ? new Date(task.scheduledEnd) : null;
  
  // 判断是否需要显示验证界面
  const needsStartVerification = 
    task.verificationStart && 
    verificationState.status === 'pending' &&
    taskStart && 
    now >= taskStart;
  
  const needsCompleteVerification = 
    task.verificationComplete &&
    verificationState.status === 'started' &&
    taskEnd &&
    now < taskEnd;
  
  // 计算剩余时间
  const getTimeLeft = () => {
    if (needsStartVerification) {
      // 启动验证：2分钟倒计时
      const deadline = verificationState.startTime || new Date(taskStart!.getTime() + 2 * 60 * 1000);
      return Math.max(0, Math.floor((deadline.getTime() - now.getTime()) / 1000));
    } else if (needsCompleteVerification) {
      // 完成验证：任务时长倒计时
      const actualStart = verificationState.actualStartTime || taskStart!;
      const elapsed = Math.floor((now.getTime() - actualStart.getTime()) / 1000);
      const total = task.durationMinutes * 60;
      return Math.max(0, total - elapsed);
    }
    return 0;
  };
  
  return (
    <div key={task.id} className="task-card mb-4">
      {/* 如果需要验证，显示验证界面 */}
      {(needsStartVerification || needsCompleteVerification) ? (
        <TaskCardVerification
          type={needsStartVerification ? 'start' : 'complete'}
          taskTitle={task.title}
          timeLeft={getTimeLeft()}
          onVerify={() => {
            if (needsStartVerification) {
              handleStartVerification(task.id);
            } else {
              handleCompleteVerification(task.id);
            }
          }}
        />
      ) : (
        <>
          {/* 正常的任务卡片内容 */}
          <div className="task-header">
            <h3>{task.title}</h3>
          </div>
          <div className="task-body">
            {/* 任务详情 */}
          </div>
          <div className="task-actions">
            {/* 按钮区域 */}
          </div>
        </>
      )}
    </div>
  );
})}
```

---

## 🎯 关键点说明

### 1. 状态持久化
```typescript
// ✅ 正确：保存到 localStorage
const [verificationStates, setVerificationStates] = useState(() => {
  const saved = localStorage.getItem('task_verification_states');
  return saved ? JSON.parse(saved) : {};
});

useEffect(() => {
  localStorage.setItem('task_verification_states', JSON.stringify(verificationStates));
}, [verificationStates]);
```

### 2. 防止状态重置
```typescript
// ❌ 错误：每次渲染都重置
const verificationState = { status: 'pending' };

// ✅ 正确：从持久化状态读取
const verificationState = getVerificationState(task.id);
```

### 3. 条件渲染
```typescript
// 如果需要验证，只显示验证界面
{needsVerification ? (
  <TaskCardVerification ... />
) : (
  // 正常任务卡片
)}
```

---

## 🧪 测试步骤

### 测试1：启动验证界面
1. 创建任务：12:38 吃饭，30分钟
2. 启用验证
3. 等到12:38
4. ✅ 任务卡片变大，只显示：
   - 任务标题
   - "请完成启动验证"
   - 倒计时 02:00
   - START 按钮
5. ✅ 其他所有按钮和信息都隐藏

### 测试2：完成验证界面
1. 点击 START 按钮，完成启动验证
2. ✅ 任务卡片变大，只显示：
   - 任务标题
   - "距离任务完成"
   - 倒计时 30分00秒
   - COMPLETE 按钮
3. ✅ 其他所有按钮和信息都隐藏

### 测试3：验证状态不会跳回
1. 完成启动验证
2. 刷新页面（F5）
3. ✅ 任务仍然显示完成验证界面
4. ✅ 不会跳回启动验证界面

### 测试4：超时提示
1. 等待2分钟不点击 START
2. ✅ 倒计时变红并闪烁
3. ✅ 显示"启动验证超时！"
4. ✅ 显示"完成任务将扣除30%金币"

---

## 🐛 常见问题

### 问题1：验证状态反复跳回
**原因：** 状态没有持久化，刷新页面后丢失

**解决：** 使用 localStorage 保存状态

### 问题2：任务卡片没有变大
**原因：** CSS 样式问题

**解决：** 确保 TaskCardVerification 组件有 `min-h-[400px]` 类名

### 问题3：倒计时不准确
**原因：** 时间计算错误

**解决：** 使用 `actualStartTime` 而不是 `scheduledStart`

---

## 📊 效果预览

### 启动验证界面（黄色渐变背景）
```
┌─────────────────────────────────────┐
│                                     │
│          处理照相馆客人的照片         │
│                                     │
│         请完成启动验证               │
│                                     │
│            02:00                    │
│                                     │
│          [ START ]                  │
│                                     │
└─────────────────────────────────────┘
```

### 完成验证界面（蓝色渐变背景）
```
┌─────────────────────────────────────┐
│                                     │
│          处理照相馆客人的照片         │
│                                     │
│         距离任务完成                 │
│                                     │
│          29分30秒                   │
│                                     │
│        [ COMPLETE ]                 │
│                                     │
└─────────────────────────────────────┘
```

---

## ✅ 完成检查清单

- [ ] 导入 TaskCardVerification 组件
- [ ] 添加 verificationStates 状态管理
- [ ] 添加 localStorage 持久化
- [ ] 修改 handleStartVerification 函数
- [ ] 修改 handleCompleteVerification 函数
- [ ] 修改任务卡片渲染逻辑
- [ ] 测试启动验证界面
- [ ] 测试完成验证界面
- [ ] 测试状态持久化
- [ ] 测试超时提示

---

## 🎉 预期效果

1. ✅ 任务到点后，卡片变大，只显示验证界面
2. ✅ 启动验证：黄色背景，02:00 倒计时，START 按钮
3. ✅ 完成验证：蓝色背景，29分30秒 倒计时，COMPLETE 按钮
4. ✅ 验证状态不会跳回
5. ✅ 刷新页面后状态保持
6. ✅ 超时有明确提示

---

**修复时间：** 2026-02-10  
**组件文件：** `src/components/verification/FullScreenVerification.tsx` ✅ 已创建  
**待修改文件：** `src/components/calendar/NewTimelineView.tsx` ⏳ 需要手动修改

