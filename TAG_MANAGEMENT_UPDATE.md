# 标签管理系统更新

## 更新时间
2026-02-09

## 更新内容

### 1. 标签统计页面新增"标签管理"区域

在 `TagStatisticsView.tsx` 的最下面添加了完整的标签管理功能：

#### 功能特性：

1. **显示所有标签**
   - 手动创建的标签
   - AI智能生成的标签
   - 用户修改过的标签
   - 包括已禁用的标签

2. **标签重命名功能**
   - 点击"编辑"按钮进入编辑模式
   - 输入新名称后按回车或失焦保存
   - **自动更新所有使用该标签的任务**
   - 例如：将"健康"改为"身体反应"后，所有原本标记为"健康"的任务都会自动更新为"身体反应"

3. **标签删除功能**
   - 点击"删除"按钮删除标签
   - 确认后会从标签库中删除
   - **自动从所有任务中移除该标签**

4. **添加新标签**
   - 点击"添加标签"按钮
   - 输入标签名称（例如：照相馆工作）
   - 新标签会立即添加到标签库中

5. **标签信息展示**
   - 显示标签emoji
   - 显示标签名称
   - 显示使用次数
   - 显示总时长
   - 显示是否禁用

### 2. AI智能标签分配优化

修改了 `aiService.ts` 中的任务分解逻辑：

#### 优先级策略：

1. **优先使用用户已有标签**
   - AI会先从标签管理中获取所有用户标签
   - 在分配标签时，优先从用户标签中选择
   - 例如：用户有"照相馆工作"标签，AI会优先使用它而不是创建"工作"

2. **智能匹配**
   - AI会智能分析任务内容
   - 从用户标签中找到最匹配的标签
   - 如果用户标签都不适合，才会创建新标签

3. **保持中文标签**
   - 所有标签必须是中文
   - 每个任务至少2个标签
   - 标签要有意义且准确

### 3. 数据同步机制

#### 标签重命名的连锁更新：

```typescript
// 1. 更新标签store
updateTag(oldName, newName);

// 2. 更新所有任务
tasks.forEach(task => {
  if (task.tags && task.tags.includes(oldName)) {
    const newTags = task.tags.map(tag => 
      tag === oldName ? newName : tag
    );
    updateTask(task.id, { tags: newTags });
  }
});
```

#### 标签删除的连锁更新：

```typescript
// 1. 删除标签store中的标签
deleteTag(tagName);

// 2. 从所有任务中移除该标签
tasks.forEach(task => {
  if (task.tags && task.tags.includes(tagName)) {
    const newTags = task.tags.filter(tag => tag !== tagName);
    updateTask(task.id, { tags: newTags });
  }
});
```

### 4. 用户界面设计

#### 布局结构：

```
┌─────────────────────────────────────┐
│  圆环图（Doughnut Chart）            │
│  - 显示标签使用占比                  │
│  - 中心显示习惯分数                  │
│  - emoji环绕在圆环上                 │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│  Summary 柱状图                      │
│  - 显示各标签时长                    │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│  标签图例                            │
│  - 2列网格布局                       │
│  - 显示颜色、emoji、名称、时长       │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│  ⭐ 标签管理（新增）                 │
│  ┌───────────────────────────────┐  │
│  │ 标题 + "添加标签"按钮          │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │ 标签列表                       │  │
│  │ - emoji + 名称 + 使用统计      │  │
│  │ - 编辑按钮 + 删除按钮          │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │ 提示信息                       │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
```

#### 交互设计：

1. **编辑标签**
   - 点击编辑按钮 → 输入框出现
   - 输入新名称 → 按回车或失焦保存
   - 按ESC取消编辑

2. **删除标签**
   - 点击删除按钮 → 弹出确认对话框
   - 确认后删除 → 自动更新所有任务

3. **添加标签**
   - 点击"添加标签" → 输入框出现
   - 输入标签名称 → 按回车或点击"确定"
   - 按ESC或点击"取消"关闭

### 5. 使用场景示例

#### 场景1：重命名标签

用户发现"健康"这个标签不够准确，想改为"身体反应"：

1. 打开标签统计页面
2. 滚动到"标签管理"区域
3. 找到"健康"标签，点击编辑按钮
4. 输入"身体反应"，按回车
5. ✅ 所有原本标记为"健康"的任务自动更新为"身体反应"

#### 场景2：添加自定义标签

用户在照相馆工作，希望AI使用"照相馆工作"而不是通用的"工作"：

1. 打开标签统计页面
2. 点击"添加标签"按钮
3. 输入"照相馆工作"
4. ✅ 标签添加成功
5. 下次AI分析任务时，会优先使用"照相馆工作"标签

#### 场景3：AI智能使用用户标签

用户说："明天去照相馆拍证件照"

AI分析流程：
1. 检测到用户有"照相馆工作"标签
2. 智能匹配：任务内容包含"照相馆"
3. ✅ 分配标签：["照相馆工作", "工作"]
4. 而不是创建新的通用标签

### 6. 技术实现细节

#### 获取用户标签：

```typescript
// 在AI服务中动态获取用户标签
let userTags: string[] = [];
try {
  const { useTagStore } = await import('@/stores/tagStore');
  const tagStore = useTagStore.getState();
  const allTags = tagStore.getAllTags();
  userTags = allTags.map(tag => tag.name);
} catch (error) {
  console.warn('获取用户标签失败:', error);
}
```

#### AI Prompt优化：

```
**用户已有标签（优先使用）：**
照相馆工作、健康、宠物、家务、生活、工作、学习

请优先从用户已有标签中选择，如果都不适合再创建新标签。
```

### 7. 数据持久化

所有标签数据通过 `zustand` + `localStorage` 持久化：

- 标签信息（名称、emoji、颜色、使用次数等）
- 标签使用记录
- 标签财务记录
- 标签分组信息

### 8. 未来优化方向

1. **标签合并功能**
   - 将多个相似标签合并为一个
   - 例如：将"健康"、"身体"、"医疗"合并为"健康"

2. **标签分组**
   - 创建标签组（例如：工作类、生活类、健康类）
   - 方便管理大量标签

3. **标签统计增强**
   - 显示标签创建来源（手动/AI生成）
   - 显示标签最后使用时间
   - 显示标签使用趋势

4. **AI学习优化**
   - 记录用户修改标签的历史
   - AI学习用户的标签偏好
   - 提高标签分配准确率

## 修改的文件

1. `src/components/tags/TagStatisticsView.tsx`
   - 新增标签管理UI
   - 新增标签重命名功能
   - 新增标签删除功能
   - 新增添加标签功能

2. `src/services/aiService.ts`
   - 优化任务分解逻辑
   - 添加用户标签获取
   - 优化AI Prompt
   - 优先使用用户已有标签

## 测试建议

1. **测试标签重命名**
   - 创建几个任务并打上"健康"标签
   - 将"健康"重命名为"身体反应"
   - 检查所有任务的标签是否自动更新

2. **测试标签删除**
   - 删除一个标签
   - 检查所有任务是否移除了该标签

3. **测试AI标签优先级**
   - 添加自定义标签"照相馆工作"
   - 让AI分析包含"照相馆"的任务
   - 检查AI是否优先使用"照相馆工作"标签

4. **测试添加标签**
   - 添加新标签
   - 检查标签是否出现在列表中
   - 检查AI是否能使用新标签

## 总结

这次更新实现了完整的标签管理系统，用户可以：

✅ 查看所有标签（手动创建、AI生成、已修改）
✅ 重命名标签（自动更新所有任务）
✅ 删除标签（自动从所有任务中移除）
✅ 添加自定义标签
✅ AI优先使用用户已有标签

这样用户就能完全掌控标签系统，AI也会更智能地使用用户偏好的标签！

