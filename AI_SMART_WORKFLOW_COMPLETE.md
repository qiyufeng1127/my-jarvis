# AI智能工作流完成文档

## 🎉 概述

成功实现了AI助手的智能工作流，包括：任务分解 → 手动编辑 → 动线优化 → 推送到时间轴的完整流程。

---

## ✅ 新增功能

### 1. **任务编辑器** ✨

**功能描述**：
- AI分解任务后，显示可视化编辑器
- 用户可以手动调整任务顺序、时长、标题
- 支持删除不需要的任务
- 实时预览开始时间（自动计算）

**操作方式**：
```
1. 用户输入一串任务
2. AI智能分解并优化动线
3. 显示任务编辑器
4. 用户手动调整（拖拽排序、修改时长）
5. 点击"推送到时间轴"按钮
6. 批量创建到时间轴
```

**UI特性**：
- 🎨 紫色边框高亮显示编辑器
- ⬆️⬇️ 上移/下移按钮调整顺序
- 🗑️ 删除按钮移除任务
- ⏱️ 实时显示时长和开始时间
- 📍 显示任务位置（厕所、工作区等）

---

### 2. **智能动线优化** 🏠

**家里格局配置**：
```
进门：
  左手边 → 厕所 (bathroom)
  右手边 → 工作区 (workspace)

往前走：
  左手边 → 厨房 (kitchen)
  右手边 → 客厅 (livingroom)

从厨房楼梯上去：
  左手边 → 卧室 (bedroom)
  右手边 → 拍摄间 (studio)
```

**动线排序逻辑**：
```javascript
LOCATION_ORDER = [
  'bathroom',    // 厕所
  'workspace',   // 工作区
  'kitchen',     // 厨房
  'livingroom',  // 客厅
  'bedroom',     // 卧室
  'studio',      // 拍摄间
]
```

**自动识别位置**：
- 洗漱 → 厕所
- 工作、编程 → 工作区
- 洗碗、倒猫粮 → 厨房
- 客厅相关 → 客厅
- 睡觉、卧室 → 卧室
- 拍摄 → 拍摄间

---

### 3. **智能时长分配** ⏱️

**时长参考表**：
| 任务类型 | 默认时长 | 说明 |
|---------|---------|------|
| 工作相关 | 60分钟 | 1小时起步 |
| 打扫收拾 | 10分钟 | 标准清洁时间 |
| 在家吃饭 | 30分钟 | 正常用餐 |
| 外出吃饭 | 120分钟 | 2小时（含路程） |
| 外出喝酒 | 240分钟 | 4小时 |
| 上楼睡觉 | 5分钟 | 快速移动 |
| 吃药 | 2分钟 | 简单操作 |
| 洗漱 | 5分钟 | 刷牙洗脸 |
| 洗碗、倒猫粮、洗衣服 | 5分钟 | 简单家务 |

**智能识别**：
- 支持明确指定时长（如"工作30分钟"）
- 自动从任务标题中提取时长
- 根据任务类型智能推断
- 未匹配的任务默认15分钟

---

### 4. **动态时间计算** 🕐

**功能特性**：
- 自动计算每个任务的开始时间
- 支持指定起始时间（如"5分钟后"）
- 调整任务顺序后自动重新计算时间
- 修改任务时长后自动更新后续任务时间

**计算逻辑**：
```
任务1: 14:00 开始，持续10分钟 → 14:10结束
任务2: 14:10 开始，持续5分钟  → 14:15结束
任务3: 14:15 开始，持续30分钟 → 14:45结束
...

如果调整顺序（任务2和任务3交换）：
任务1: 14:00 开始，持续10分钟 → 14:10结束
任务3: 14:10 开始，持续30分钟 → 14:40结束
任务2: 14:40 开始，持续5分钟  → 14:45结束
```

---

### 5. **增强的AI提示词** 🤖

**新增提示词内容**：
```
请帮我分解任务，并注意：
1. 识别每个任务的位置（厕所、工作区、厨房、客厅、卧室、拍摄间）
2. 按照家里格局优化动线：进门左手边是厕所，右手边是工作区；
   往前走左手边是厨房，右手边是客厅；
   从厨房楼梯上去左手边是卧室，右手边是拍摄间
3. 根据任务类型智能分配时长：
   - 工作相关：60分钟起步
   - 打扫收拾：10分钟
   - 在家吃饭：30分钟
   - 外出吃饭：120分钟
   - 外出喝酒：240分钟
   - 上楼睡觉：5分钟
   - 吃药：2分钟
   - 洗漱：5分钟
   - 洗碗、倒猫粮、洗衣服等简单家务：5分钟

请返回JSON格式，包含location字段。
```

---

## 🎯 完整工作流

### 示例：一串自然语言任务

**用户输入**：
```
5分钟后去洗漱，然后洗碗，倒猫粮，洗衣服，工作30分钟，收拾卧室、客厅和拍摄间
```

**AI处理流程**：

#### 步骤1：智能分解
```
AI识别到7个任务：
1. 去洗漱
2. 洗碗
3. 倒猫粮
4. 洗衣服
5. 工作30分钟
6. 收拾卧室
7. 收拾客厅
8. 收拾拍摄间
```

#### 步骤2：识别位置
```
1. 去洗漱 → 厕所 (bathroom)
2. 洗碗 → 厨房 (kitchen)
3. 倒猫粮 → 厨房 (kitchen)
4. 洗衣服 → 厨房 (kitchen)
5. 工作30分钟 → 工作区 (workspace)
6. 收拾卧室 → 卧室 (bedroom)
7. 收拾客厅 → 客厅 (livingroom)
8. 收拾拍摄间 → 拍摄间 (studio)
```

#### 步骤3：智能分配时长
```
1. 去洗漱 → 5分钟
2. 洗碗 → 5分钟
3. 倒猫粮 → 5分钟
4. 洗衣服 → 5分钟
5. 工作30分钟 → 30分钟（用户指定）
6. 收拾卧室 → 10分钟
7. 收拾客厅 → 10分钟
8. 收拾拍摄间 → 10分钟
```

#### 步骤4：动线优化排序
```
按照家里格局优化后的顺序：
1. 去洗漱 (厕所) - 5分钟
2. 洗碗 (厨房) - 5分钟
3. 倒猫粮 (厨房) - 5分钟
4. 洗衣服 (厨房) - 5分钟
5. 收拾客厅 (客厅) - 10分钟
6. 工作30分钟 (工作区) - 30分钟
7. 收拾卧室 (卧室) - 10分钟
8. 收拾拍摄间 (拍摄间) - 10分钟
```

#### 步骤5：计算开始时间
```
假设当前时间是 14:00，用户说"5分钟后"，起始时间是 14:05

1. 去洗漱 - 14:05 (5分钟)
2. 洗碗 - 14:10 (5分钟)
3. 倒猫粮 - 14:15 (5分钟)
4. 洗衣服 - 14:20 (5分钟)
5. 收拾客厅 - 14:25 (10分钟)
6. 工作30分钟 - 14:35 (30分钟)
7. 收拾卧室 - 15:05 (10分钟)
8. 收拾拍摄间 - 15:15 (10分钟)

总计：80分钟，15:25完成
```

#### 步骤6：显示编辑器
```
🤖 AI智能任务分解 + 动线优化

我帮你把任务分解成了 8 个具体步骤，并按照家里格局优化了动线：

1. 🟢 去洗漱
   🚽 厕所 | ⏱️ 5 分钟 | 🕐 14:05

2. 🟢 洗碗
   🍳 厨房 | ⏱️ 5 分钟 | 🕐 14:10

3. 🟢 倒猫粮
   🍳 厨房 | ⏱️ 5 分钟 | 🕐 14:15

4. 🟢 洗衣服
   🍳 厨房 | ⏱️ 5 分钟 | 🕐 14:20

5. 🟢 收拾客厅
   🛋️ 客厅 | ⏱️ 10 分钟 | 🕐 14:25

6. 🟡 工作30分钟
   💻 工作区 | ⏱️ 30 分钟 | 🕐 14:35

7. 🟢 收拾卧室
   🛏️ 卧室 | ⏱️ 10 分钟 | 🕐 15:05

8. 🟢 收拾拍摄间
   📸 拍摄间 | ⏱️ 10 分钟 | 🕐 15:15

💡 你可以在下方编辑器中调整任务顺序和时长，然后点击"推送到时间轴"！
```

#### 步骤7：用户手动调整

**编辑器界面**：
```
✏️ 任务编辑器                    [取消]

┌─────────────────────────────────────┐
│ #1 [去洗漱________________] 🗑️      │
│    ⏱️ [5] 分钟 🕐 14:05 📍 bathroom │
│    [⬆️ 上移] [⬇️ 下移]              │
├─────────────────────────────────────┤
│ #2 [洗碗__________________] 🗑️      │
│    ⏱️ [5] 分钟 🕐 14:10 📍 kitchen  │
│    [⬆️ 上移] [⬇️ 下移]              │
├─────────────────────────────────────┤
│ ... (其他任务)                      │
└─────────────────────────────────────┘

[🚀 推送到时间轴 (8 个任务)]
```

**用户操作**：
- 修改"工作30分钟"为"工作60分钟"
- 将"工作"任务上移到第2位
- 删除"收拾拍摄间"任务

**调整后的结果**：
```
1. 去洗漱 - 14:05 (5分钟)
2. 工作60分钟 - 14:10 (60分钟) ← 上移并修改时长
3. 洗碗 - 15:10 (5分钟) ← 时间自动重新计算
4. 倒猫粮 - 15:15 (5分钟)
5. 洗衣服 - 15:20 (5分钟)
6. 收拾客厅 - 15:25 (10分钟)
7. 收拾卧室 - 15:35 (10分钟)
(已删除：收拾拍摄间)

总计：100分钟，15:45完成
```

#### 步骤8：推送到时间轴
```
用户点击"推送到时间轴"按钮

AI执行：
✅ 批量创建7个任务到时间轴
✅ 设置每个任务的开始时间和结束时间
✅ 关联长期目标（如果有）
✅ 设置任务类型、优先级

显示成功消息：
✅ 太棒了！已成功推送 7 个任务到时间轴！

📅 你可以在时间轴模块查看和管理这些任务。
💡 完成任务后记得标记完成，可以获得金币和成长值哦！
```

---

## 🔧 技术实现

### 核心函数

#### 1. `detectTaskLocation(title: string)`
```typescript
// 智能识别任务位置
if (/厕所|洗手间|卫生间|洗漱/.test(title)) return 'bathroom';
if (/工作|电脑|办公|写代码|编程/.test(title)) return 'workspace';
if (/厨房|做饭|洗碗|猫粮|倒水/.test(title)) return 'kitchen';
// ...
```

#### 2. `detectTaskDuration(title: string)`
```typescript
// 智能识别任务时长
// 1. 检查明确指定的时长
const durationMatch = title.match(/(\d+)(分钟|小时)/);
if (durationMatch) {
  const value = parseInt(durationMatch[1]);
  const unit = durationMatch[2];
  return unit === '小时' ? value * 60 : value;
}

// 2. 根据任务类型推断
if (/工作|编程|写代码|开发/.test(title)) return 60;
if (/打扫|收拾|整理/.test(title)) return 10;
// ...
```

#### 3. `optimizeTasksByLocation(tasks)`
```typescript
// 按动线优化任务顺序
return [...tasks].sort((a, b) => {
  const indexA = LOCATION_ORDER.indexOf(a.location);
  const indexB = LOCATION_ORDER.indexOf(b.location);
  return indexA - indexB;
});
```

#### 4. `recalculateTaskTimes(tasks, startTime)`
```typescript
// 重新计算任务时间
let currentTime = new Date(startTime || new Date());

return tasks.map((task) => {
  const taskStartTime = new Date(currentTime);
  const hours = taskStartTime.getHours().toString().padStart(2, '0');
  const minutes = taskStartTime.getMinutes().toString().padStart(2, '0');
  
  // 更新当前时间（加上任务持续时间）
  currentTime = new Date(currentTime.getTime() + task.duration * 60000);
  
  return {
    ...task,
    startTime: `${hours}:${minutes}`,
  };
});
```

#### 5. `handleTaskReorder(fromIndex, toIndex)`
```typescript
// 处理任务重新排序
const newTasks = [...editingTasks];
const [movedTask] = newTasks.splice(fromIndex, 1);
newTasks.splice(toIndex, 0, movedTask);

// 重新计算时间
const updatedTasks = recalculateTaskTimes(newTasks);
setEditingTasks(updatedTasks);
```

#### 6. `handleTaskDurationChange(taskId, newDuration)`
```typescript
// 处理任务时长修改
const newTasks = editingTasks.map(task =>
  task.id === taskId ? { ...task, duration: newDuration } : task
);

// 重新计算时间
const updatedTasks = recalculateTaskTimes(newTasks);
setEditingTasks(updatedTasks);
```

#### 7. `handlePushToTimeline()`
```typescript
// 推送任务到时间轴
for (const taskData of editingTasks) {
  await createTask({
    title: taskData.title,
    taskType: taskData.category as TaskType,
    durationMinutes: taskData.duration,
    scheduledStart: parseTime(taskData.startTime),
    scheduledEnd: parseTime(taskData.startTime) + taskData.duration,
    // ...
  });
}
```

---

## 📊 数据流

```
用户输入
  ↓
检测任务创建意图
  ↓
需要分解？
  ↓ Yes
调用 aiService.decomposeTask(enhancedPrompt)
  ↓
AI返回任务列表
  ↓
为每个任务添加ID和元数据
  ↓
detectTaskLocation() - 识别位置
detectTaskDuration() - 识别时长
  ↓
optimizeTasksByLocation() - 动线优化
  ↓
recalculateTaskTimes() - 计算时间
  ↓
显示任务编辑器
  ↓
用户手动调整
  ├─ handleTaskReorder() - 调整顺序
  ├─ handleTaskDurationChange() - 修改时长
  ├─ handleTaskTitleChange() - 修改标题
  └─ handleDeleteTask() - 删除任务
  ↓
每次调整后自动 recalculateTaskTimes()
  ↓
用户点击"推送到时间轴"
  ↓
handlePushToTimeline()
  ↓
批量调用 createTask()
  ↓
显示成功消息
  ↓
清空编辑状态
```

---

## 🎨 UI/UX 特性

### 1. **任务编辑器样式**
- 紫色边框高亮（`border-2 border-purple-500`）
- 圆角卡片设计
- 阴影效果增强层次感
- 最大高度限制 + 滚动条

### 2. **任务卡片**
- 灰色背景区分
- 序号标识（#1, #2, ...）
- 输入框实时编辑
- 删除按钮右上角

### 3. **操作按钮**
- 上移/下移按钮（禁用状态灰化）
- 推送按钮渐变色（紫色到蓝色）
- Hover效果（scale-105）
- 禁用状态半透明

### 4. **信息显示**
- Emoji图标增强可读性
- 位置、时长、时间一目了然
- 实时更新（调整后立即显示新时间）

### 5. **快速指令**
- "分解任务"按钮预填示例文本
- 一键体验完整流程

---

## 💡 使用技巧

### 1. **自然语言输入**
```
✅ 好的示例：
- "5分钟后去洗漱，然后洗碗，倒猫粮，洗衣服，工作30分钟，收拾卧室、客厅和拍摄间"
- "明天上午9点开会，然后写报告，下午3点健身"
- "先去厨房做饭，吃完饭去客厅看电视，然后上楼睡觉"

❌ 不好的示例：
- "任务1、任务2、任务3"（太抽象）
- "做事情"（不具体）
```

### 2. **指定时长**
```
✅ 明确指定：
- "工作30分钟"
- "学习2小时"
- "锻炼45分钟"

✅ 让AI推断：
- "工作"（默认60分钟）
- "打扫卧室"（默认10分钟）
- "洗碗"（默认5分钟）
```

### 3. **指定开始时间**
```
✅ 相对时间：
- "5分钟后去洗漱"
- "10分钟后开始工作"

✅ 绝对时间：
- "明天上午9点开会"
- "下午3点健身"
```

### 4. **手动调整技巧**
```
✅ 调整顺序：
- 使用"上移/下移"按钮
- 时间会自动重新计算

✅ 修改时长：
- 直接在输入框中修改数字
- 后续任务时间自动更新

✅ 删除任务：
- 点击🗑️按钮
- 后续任务时间自动前移
```

---

## 🚀 未来优化方向

### 1. **拖拽排序**
- 支持鼠标拖拽调整顺序
- 更直观的交互体验

### 2. **任务模板**
- 保存常用任务组合
- 一键应用模板

### 3. **智能建议**
- AI分析用户习惯
- 推荐最佳任务顺序和时间

### 4. **冲突检测**
- 检测时间冲突
- 自动调整避免重叠

### 5. **批量操作**
- 批量修改时长
- 批量删除任务

---

## 📝 总结

### 核心价值

✅ **智能化**：
- AI自动分解任务
- 智能识别位置和时长
- 动线优化节省时间

✅ **可控性**：
- 用户完全掌控最终结果
- 手动调整灵活方便
- 实时预览所有变化

✅ **高效性**：
- 一次输入多个任务
- 自动计算时间
- 一键推送到时间轴

✅ **人性化**：
- 自然语言输入
- 可视化编辑器
- 清晰的反馈提示

### 工作流对比

**之前**：
```
输入任务 → AI分析 → 直接创建 → 无法调整
```

**现在**：
```
输入任务 → AI分析 → 显示编辑器 → 手动调整 → 推送创建
         ↓
    动线优化
    时长分配
    时间计算
```

### 用户体验提升

- 🎯 **更精准**：手动调整确保任务符合实际需求
- ⚡ **更高效**：批量处理多个任务，节省时间
- 🏠 **更智能**：动线优化减少不必要的移动
- 🕐 **更清晰**：实时显示时间，一目了然

---

## 🎉 完成状态

✅ 任务编辑器 - 完成
✅ 智能动线优化 - 完成
✅ 智能时长分配 - 完成
✅ 动态时间计算 - 完成
✅ 增强AI提示词 - 完成
✅ 推送到时间轴 - 完成
✅ UI/UX优化 - 完成

**现在你可以用自然语言一次性安排一整天的任务，AI会帮你优化动线、分配时间，你只需要微调后一键推送！** 🚀

