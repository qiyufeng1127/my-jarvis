# 任务完成效率追踪功能说明

## 功能概述

任务完成时，如果任务设置了图片验证且计划拍照次数 > 0，系统会自动弹出效率评估模态框，让用户评估任务完成效率（0-100%）。

## 已完成的工作

### 1. 创建效率模态框组件
- **文件**: `src/components/calendar/TaskCompletionEfficiencyModal.tsx`
- **功能**:
  - 可拖动的进度滑块（0-100%）
  - 实时显示效率等级（优秀/良好/一般/较差）
  - 显示计划拍照次数 vs 实际拍照次数
  - 效率低于50%时显示警告提示
  - 动态颜色变化（根据效率等级）

### 2. 创建坏习惯追踪 Store
- **文件**: `src/stores/habitStore.ts`
- **功能**:
  - 记录三种坏习惯：低效率、启动拖延、完成超时
  - 支持按任务、按类型、按日期查询
  - 持久化到 localStorage

### 3. 扩展 Task 类型定义
- **文件**: `src/types/index.ts`
- **新增字段**:
  - `requireImageUpload`: 是否需要上传图片
  - `plannedImageCount`: 计划拍照次数
  - `actualImageCount`: 实际拍照次数
  - `completionEfficiency`: 完成效率 (0-100)
  - `efficiencyLevel`: 效率等级 ('excellent' | 'good' | 'average' | 'poor')

### 4. 扩展 TaskStore
- **文件**: `src/stores/taskStore.ts`
- **新增方法**: `updateTaskEfficiency(taskId, efficiency, actualImageCount)`
- **功能**:
  - 更新任务效率数据
  - 自动计算效率等级
  - 效率 < 50% 时自动记录到坏习惯

### 5. 集成到任务完成流程
- **文件**: `src/components/calendar/NewTimelineView.tsx`
- **修改点**:
  - 导入效率模态框组件和 taskStore
  - 添加效率模态框状态管理
  - 修改 `onComplete` 回调，检查是否需要效率评估
  - 在组件末尾渲染效率模态框

## 使用流程

1. **创建任务时**：
   - 在任务编辑器中设置"计划拍照次数"（例如：5次）
   - 启用图片验证功能

2. **完成任务时**：
   - 用户完成任务验证后
   - 系统检测到 `plannedImageCount > 0`
   - 自动弹出效率模态框

3. **效率评估**：
   - 用户拖动滑块选择效率（0-100%）
   - 系统显示：
     - 计划拍照次数：5次
     - 实际拍照次数：3次
     - 当前效率：60%（良好）
   - 如果效率 < 50%，显示警告

4. **确认完成**：
   - 用户点击"确认完成"
   - 系统更新任务效率数据
   - 如果效率 < 50%，自动记录到坏习惯
   - 任务标记为已完成

## 效率等级划分

- **优秀** (90-100%): 绿色 (#10b981)
- **良好** (70-89%): 蓝色 (#3b82f6)
- **一般** (50-69%): 橙色 (#f59e0b)
- **较差** (0-49%): 红色 (#ef4444) - 记录为坏习惯

## 坏习惯追踪

当效率 < 50% 时，系统会自动记录：
- 任务ID和标题
- 效率百分比
- 时间戳
- 描述信息

用户可以在坏习惯页面查看历史记录，帮助改进工作效率。

## 百度AI图片验证问题诊断

### 问题描述
用户反馈：AI图片验证要么全部通过，要么全部失败，无法正确识别图片内容。

### 已添加的诊断功能

1. **详细日志输出**：
   - API配置状态检查
   - 识别结果统计（通用物体、场景、物体检测）
   - 关键词匹配详情
   - 失败原因分析

2. **错误提示优化**：
   - 未识别到内容时，给出详细的排查步骤
   - 区分不同错误类型（API配置、网络、图片质量、超额）
   - 提供具体的解决建议

3. **验证逻辑**：
   - 使用三种识别API并行调用（通用物体、场景、物体检测）
   - 宽松匹配策略（包含匹配、同义词匹配）
   - 阈值设置为 5%（非常宽松）

### 可能的问题原因

1. **API未配置或配置错误**：
   - 检查【设置 → AI】中的百度API配置
   - 确认 API Key 和 Secret Key 正确
   - 确认已开通图像识别服务

2. **网络问题**：
   - 检查网络连接
   - 检查是否能访问百度AI服务
   - 检查防火墙设置

3. **图片质量问题**：
   - 确保光线充足
   - 拍摄目标清晰可见
   - 避免过度模糊或反光

4. **超出免费额度**：
   - 百度AI每天免费500次
   - 检查是否超出额度

### 下一步调试建议

1. **查看控制台日志**：
   - 打开浏览器开发者工具（F12）
   - 查看 Console 标签
   - 搜索 "[百度API]" 关键词
   - 查看识别结果和匹配详情

2. **测试API配置**：
   - 使用诊断页面测试API（如果已创建）
   - 上传测试图片查看识别结果
   - 确认API能正常返回数据

3. **调整验证策略**：
   - 如果识别结果正常但匹配失败，可能是关键词设置不合理
   - 建议使用更通用的关键词（如"电脑"而不是"MacBook Pro"）
   - 或者降低匹配要求（已经是5%了，很宽松）

## 注意事项

1. 效率模态框只在有图片验证且计划拍照次数 > 0 时显示
2. 效率数据会持久化到 localStorage
3. 坏习惯记录会累积，可用于长期分析
4. 百度AI验证需要正确配置API密钥才能工作

## 后续优化建议

1. 添加效率趋势图表
2. 添加效率排行榜
3. 添加效率改进建议（AI分析）
4. 添加坏习惯改进计划
5. 优化百度AI识别准确率（调整同义词库、匹配策略）

